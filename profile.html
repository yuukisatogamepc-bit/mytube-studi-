<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>プロフィール - Mvideo</title>
    <style>
        body { font-family: sans-serif; margin: 0; background: #fff; display: flex; flex-direction: column; align-items: center; }
        header { width: 100%; padding: 10px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; box-sizing: border-box; }
        .logo { font-size: 22px; font-weight: bold; text-decoration: none; color: #ff0000; }
        
        .container { max-width: 600px; width: 100%; padding: 40px 20px; text-align: center; }
        .profile-card { border: 1px solid #eee; padding: 30px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        
        .icon-edit-area { position: relative; width: 100px; height: 100px; margin: 0 auto 20px; }
        .u-icon-large { width: 100px; height: 100px; border-radius: 50%; background: #eee; object-fit: cover; border: 1px solid #eee; }
        .file-label { position: absolute; bottom: 0; right: 0; background: #ff0000; color: #fff; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 18px; border: 2px solid #fff; }
        #fileInput { display: none; }
        
        .input-group { margin-bottom: 20px; text-align: left; }
        label { display: block; font-size: 14px; color: #606060; margin-bottom: 5px; }
        input[type="text"] { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; font-size: 16px; }
        
        .btn { width: 100%; padding: 12px; border-radius: 25px; border: none; font-weight: bold; cursor: pointer; margin-top: 10px; font-size: 16px; transition: 0.2s; }
        .btn-save { background: #ff0000; color: #fff; }
        .btn-save:disabled { background: #ccc; cursor: not-allowed; }
        .btn-logout { background: #eee; color: #606060; margin-top: 20px; }
        
        .msg { margin-top: 15px; font-size: 14px; color: #28a745; display: none; }
        .loading { font-size: 12px; color: #606060; margin-top: 5px; display: none; }
    </style>
</head>
<body>

<header>
    <a href="index.html" class="logo">Mvideo</a>
</header>

<div class="container">
    <div class="profile-card">
        <div class="icon-edit-area">
            <img id="displayIcon" class="u-icon-large" src="">
            <label for="fileInput" class="file-label">+</label>
            <input type="file" id="fileInput" accept="image/*">
        </div>
        <div id="loadingText" class="loading">画像を処理中...</div>
        
        <div class="input-group">
            <label>ユーザー名</label>
            <input type="text" id="userNameInput" placeholder="名前を入力">
        </div>

        <button class="btn btn-save" id="saveBtn">設定を保存</button>
        <div id="saveMsg" class="msg">保存しました！</div>
        
        <button class="btn btn-logout" id="logoutBtn">ログアウト</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // Cloudinary 設定反映
    const CLOUD_NAME = "du5blunb0"; 
    const UPLOAD_PRESET = "mytube_preset"; 

    const firebaseConfig = {
        apiKey: "AIzaSyAZivYKOGc1tSUAIDq_c10C1wJ-Pdh0U2o",
        authDomain: "mytube-f4544.firebaseapp.com",
        projectId: "mytube-f4544",
        storageBucket: "mytube-f4544.firebasestorage.app",
        messagingSenderId: "655444283107",
        appId: "1:655444283107:web:04f9173faf2d951790ffd6"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let uid = null;
    let currentIconUrl = "";

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            uid = user.uid;
            const uSnap = await getDoc(doc(db, "users", uid));
            if (uSnap.exists()) {
                const data = uSnap.data();
                document.getElementById('userNameInput').value = data.name || "";
                currentIconUrl = data.icon || "";
                document.getElementById('displayIcon').src = currentIconUrl;
            }
        } else {
            location.href = "login.html";
        }
    });

    // Cloudinary アップロード
    document.getElementById('fileInput').onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const loadingText = document.getElementById('loadingText');
        const saveBtn = document.getElementById('saveBtn');
        
        loadingText.style.display = 'block';
        saveBtn.disabled = true;

        const formData = new FormData();
        formData.append("file", file);
        formData.append("upload_preset", UPLOAD_PRESET);

        try {
            const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, {
                method: "POST",
                body: formData
            });
            const data = await res.json();
            
            if (data.secure_url) {
                currentIconUrl = data.secure_url;
                document.getElementById('displayIcon').src = currentIconUrl;
            } else {
                throw new Error("Upload failed");
            }
        } catch (error) {
            console.error(error);
            alert("アップロード失敗：Cloudinaryの『Unsigned』設定を確認してください");
        } finally {
            loadingText.style.display = 'none';
            saveBtn.disabled = false;
        }
    };

    document.getElementById('saveBtn').onclick = async () => {
        const newName = document.getElementById('userNameInput').value;
        if (!newName) return alert("名前を入力してください");

        const uRef = doc(db, "users", uid);
        await setDoc(uRef, {
            name: newName,
            icon: currentIconUrl
        }, { merge: true });

        const msg = document.getElementById('saveMsg');
        msg.style.display = 'block';
        setTimeout(() => { msg.style.display = 'none'; }, 3000);
    };

    document.getElementById('logoutBtn').onclick = async () => {
        if (confirm("ログアウトしますか？")) {
            await signOut(auth);
            location.href = "index.html";
        }
    };
</script>
</body>
</html>

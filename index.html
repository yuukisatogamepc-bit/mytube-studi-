<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, query, orderBy, onSnapshot, doc, getDoc, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAZivYKOGc1tSUAIDq_c10C1wJ-Pdh0U2o",
        authDomain: "mytube-f4544.firebaseapp.com",
        projectId: "mytube-f4544",
        storageBucket: "mytube-f4544.firebasestorage.app",
        messagingSenderId: "655444283107",
        appId: "1:655444283107:web:04f9173faf2d951790ffd6"
    };

    // あなたのUID（さっきcheck.htmlでコピーしたものに書き換えてください）
    const ADMIN_UID = "ここにあなたのUIDを貼る"; 

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();
    let currentUser = null;
    let isAdminMode = false; // 管理者モードの状態

    // --- 隠しコマンド判定のロジック ---
    const secretCode = "abbmytube";
    let inputBuffer = "";

    window.addEventListener('keydown', (e) => {
        inputBuffer += e.key.toLowerCase();
        if (inputBuffer.length > secretCode.length) {
            inputBuffer = inputBuffer.substring(inputBuffer.length - secretCode.length);
        }
        
        if (inputBuffer === secretCode) {
            isAdminMode = !isAdminMode; // モード切替
            alert(isAdminMode ? "管理者モード：ON" : "管理者モード：OFF");
            loadVideos(currentUser); // 表示を更新
            inputBuffer = ""; // バッファをリセット
        }
    });

    onAuthStateChanged(auth, async (user) => {
        currentUser = user;
        const area = document.getElementById('userArea');
        if (user) {
            const userDoc = await getDoc(doc(db, "users", user.uid));
            let userData = userDoc.exists() ? userDoc.data() : { name: user.displayName, icon: user.photoURL };
            area.innerHTML = `
                <a href="upload.html" class="btn-upload">投稿</a>
                <img src="${userData.icon}" class="user-icon" id="userIconImg">
                <button onclick="signOut(getAuth())" style="font-size:10px;">ログアウト</button>
            `;
            document.getElementById('userIconImg').onclick = () => {
                document.getElementById('editName').value = userData.name;
                document.getElementById('editIcon').value = userData.icon;
                document.getElementById('profileModal').style.display = 'block';
            };
        } else {
            area.innerHTML = `<button id="loginBtnIn">ログイン</button>`;
            const btn = document.getElementById('loginBtnIn');
            if(btn) btn.onclick = () => signInWithPopup(auth, provider);
        }
        loadVideos(user);
    });

    function loadVideos(user) {
        const q = query(collection(db, "videos"), orderBy("createdAt", "desc"));
        onSnapshot(q, (snapshot) => {
            const list = document.getElementById('videoList');
            list.innerHTML = "";
            snapshot.forEach((vDoc) => {
                const data = vDoc.data();
                const card = document.createElement('div');
                card.className = 'video-card';
                
                // 管理者モードがON、かつUIDが一致している時だけ削除ボタンを出す
                const isRealAdmin = user && user.uid === ADMIN_UID && isAdminMode;
                const isOwner = user && data.userId === user.uid;
                
                card.innerHTML = `
                    <video src="${data.url}" onclick="location.href='watch.html?id=${vDoc.id}'"></video>
                    ${(isRealAdmin || isOwner) ? `<button class="delete-btn" onclick="deleteVideo('${vDoc.id}')">${isRealAdmin ? '管理者削除' : '削除'}</button>` : ''}
                    <div class="video-info"><div class="video-title">${data.title}</div></div>
                `;
                list.appendChild(card);
            });
        });
    }

    window.deleteVideo = async (id) => {
        if (confirm("この動画を消去しますか？")) {
            await deleteDoc(doc(db, "videos", id));
        }
    };

    window.saveProfile = async () => {
        await setDoc(doc(db, "users", currentUser.uid), {
            name: document.getElementById('editName').value,
            icon: document.getElementById('editIcon').value,
            uid: currentUser.uid
        }, { merge: true });
        location.reload();
    };
</script>

<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MyTube - ãƒ›ãƒ¼ãƒ </title>
    <style>
        :root { --yt-bg: #ffffff; --yt-text: #0f0f0f; --yt-gray: #606060; --yt-card: #f2f2f2; }
        body { font-family: "Roboto", Arial, sans-serif; margin: 0; background: var(--yt-bg); color: var(--yt-text); }
        
        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        header { display: flex; align-items: center; justify-content: space-between; padding: 10px 15px; background: var(--yt-bg); border-bottom: 1px solid #ddd; position: sticky; top: 0; z-index: 100; }
        .logo { color: #ff0000; font-size: 20px; font-weight: bold; cursor: pointer; text-decoration: none; }
        .header-right { display: flex; align-items: center; gap: 12px; }
        
        /* å‹•ç”»ã‚°ãƒªãƒƒãƒ‰ */
        .video-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px; padding: 16px; }
        .v-card-wrapper { position: relative; }
        .v-card { cursor: pointer; text-decoration: none; color: inherit; display: block; }
        .thumb-container { width: 100%; aspect-ratio: 16/9; border-radius: 12px; overflow: hidden; background: #eee; }
        .thumb-img { width: 100%; height: 100%; object-fit: cover; opacity: 0; transition: opacity 0.3s; }
        .v-info { display: flex; gap: 12px; margin-top: 12px; }
        .v-icon { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; flex-shrink: 0; background: #eee; }
        .v-title { font-size: 16px; font-weight: bold; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .v-meta { font-size: 14px; color: var(--yt-gray); margin-top: 4px; }

        /* å‰Šé™¤ãƒœã‚¿ãƒ³ */
        .del-btn { position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.7); color: white; border: none; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; z-index: 10; font-size: 14px; display: flex; align-items: center; justify-content: center; }
        .del-btn:hover { background: #ff0000; }

        /* ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å¤‰æ›´ãƒ¢ãƒ¼ãƒ€ãƒ« */
        #profileModal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 24px; border-radius: 16px; box-shadow: 0 8px 30px rgba(0,0,0,0.3); z-index: 1000; width: 90%; max-width: 360px; }
        #profileModal h3 { margin: 0 0 16px 0; }
        #profileModal label { display: block; font-size: 12px; font-weight: bold; margin-bottom: 4px; color: var(--yt-gray); }
        #profileModal input { width: 100%; margin-bottom: 16px; padding: 10px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; }
        .modal-btns { display: flex; gap: 10px; justify-content: flex-end; }
        .overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index: 999; }

        .yt-btn { background: var(--yt-card); color: #0f0f0f; border: none; padding: 8px 16px; border-radius: 20px; font-weight: bold; cursor: pointer; font-size: 14px; }
        .yt-btn.active { background: #0f0f0f; color: #fff; }
        .icon-btn { font-size: 22px; cursor: pointer; background: none; border: none; padding: 0; }
    </style>
</head>
<body>

<header>
    <a href="index.html" class="logo">MyTube</a>
    <div class="header-right" id="headerRight"></div>
</header>

<div class="overlay" id="overlay" onclick="closeProfile()"></div>
<div id="profileModal">
    <h3>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†</h3>
    <label>åå‰</label>
    <input type="text" id="newUserName" placeholder="æ–°ã—ã„åå‰ã‚’å…¥åŠ›">
    <label>ã‚¢ã‚¤ã‚³ãƒ³ç”»åƒ</label>
    <input type="file" id="newUserIcon" accept="image/*">
    <div class="modal-btns">
        <button class="yt-btn" onclick="closeProfile()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="yt-btn active" id="saveProfileBtn" onclick="saveProfile()">ä¿å­˜</button>
    </div>
</div>

<div class="video-grid" id="videoGrid"></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, doc, getDoc, updateDoc, deleteDoc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAZivYKOGc1tSUAIDq_c10C1wJ-Pdh0U2o",
        authDomain: "mytube-f4544.firebaseapp.com",
        projectId: "mytube-f4544",
        storageBucket: "mytube-f4544.firebasestorage.app",
        messagingSenderId: "655444283107",
        appId: "1:655444283107:web:04f9173faf2d951790ffd6"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const storage = getStorage(app);

    let user = null;

    // ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ç›£è¦– & ãƒ˜ãƒƒãƒ€ãƒ¼æ›´æ–°
    onAuthStateChanged(auth, async u => {
        user = u;
        const hr = document.getElementById('headerRight');
        if(u) {
            const uSnap = await getDoc(doc(db, "users", u.uid));
            const userData = uSnap.data();
            hr.innerHTML = `
                <button class="icon-btn" onclick="location.href='upload.html'">ğŸ“¤</button>
                <button class="yt-btn" onclick="openProfile()">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†</button>
                <img src="${userData?.icon || ''}" style="width:32px;height:32px;border-radius:50%;cursor:pointer;object-fit:cover;" onclick="window.logout()">
            `;
            document.getElementById('newUserName').value = userData?.name || "";
        } else {
            hr.innerHTML = `<button class="yt-btn active" onclick="location.href='login.html'">ãƒ­ã‚°ã‚¤ãƒ³</button>`;
        }
        loadVideos();
    });

    // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å¤‰æ›´æ©Ÿèƒ½
    window.openProfile = () => { document.getElementById('profileModal').style.display = 'block'; document.getElementById('overlay').style.display = 'block'; };
    window.closeProfile = () => { document.getElementById('profileModal').style.display = 'none'; document.getElementById('overlay').style.display = 'none'; };

    window.saveProfile = async () => {
        const newName = document.getElementById('newUserName').value;
        const iconFile = document.getElementById('newUserIcon').files[0];
        const btn = document.getElementById('saveProfileBtn');
        if(!user || !newName) return;

        btn.disabled = true;
        btn.innerText = "ä¿å­˜ä¸­...";

        try {
            let updateData = { name: newName };
            if(iconFile) {
                const iRef = ref(storage, `icons/${user.uid}`);
                await uploadBytes(iRef, iconFile);
                updateData.icon = await getDownloadURL(iRef);
            }
            await updateDoc(doc(db, "users", user.uid), updateData);
            alert("ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼");
            location.reload();
        } catch (e) {
            alert("ã‚¨ãƒ©ãƒ¼: " + e.message);
            btn.disabled = false;
            btn.innerText = "ä¿å­˜";
        }
    };

    window.logout = () => { if(confirm("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ")) signOut(auth).then(()=>location.reload()); };

    // è‡ªå‹•ã‚µãƒ ãƒã‚¤ãƒ«
    async function generateThumb(url, imgElement) {
        const video = document.createElement('video');
        video.src = url; video.preload = "auto"; video.muted = true; video.crossOrigin = "anonymous";
        video.addEventListener('loadeddata', () => { video.currentTime = 1.0; });
        video.addEventListener('seeked', () => {
            const canvas = document.createElement('canvas');
            canvas.width = 320; canvas.height = 180;
            canvas.getContext('2d').drawImage(video, 0, 0, 320, 180);
            imgElement.src = canvas.toDataURL('image/jpeg', 0.8);
            imgElement.style.opacity = 1;
        });
        video.load();
    }

    // å‹•ç”»èª­ã¿è¾¼ã¿ & å‰Šé™¤ãƒœã‚¿ãƒ³è¡¨ç¤º
    function loadVideos() {
        const q = query(collection(db, "videos"), orderBy("createdAt", "desc"));
        onSnapshot(q, snap => {
            const grid = document.getElementById('videoGrid');
            grid.innerHTML = "";
            snap.forEach(async vDoc => {
                const vd = vDoc.data();
                const vId = vDoc.id;
                const sid = `thumb-${vId}`;
                
                const wrapper = document.createElement('div');
                wrapper.className = "v-card-wrapper";

                // å‹•ç”»ã‚«ãƒ¼ãƒ‰æœ¬ä½“
                const card = document.createElement('a');
                card.className = "v-card";
                card.href = `watch.html?id=${vId}`;
                card.innerHTML = `
                    <div class="thumb-container">
                        <img src="" class="thumb-img" id="${sid}">
                    </div>
                    <div class="v-info">
                        <img src="" class="v-icon" id="icon-${vId}">
                        <div>
                            <div class="v-title">${vd.title}</div>
                            <div class="v-meta">${(vd.views||0).toLocaleString()}å›è¦–è´</div>
                        </div>
                    </div>
                `;
                wrapper.appendChild(card);

                // è‡ªåˆ†ã®å‹•ç”»ãªã‚‰å‰Šé™¤ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
                if (user && vd.userId === user.uid) {
                    const delBtn = document.createElement('button');
                    delBtn.className = "del-btn";
                    delBtn.innerHTML = "ğŸ—‘ï¸";
                    delBtn.title = "å‹•ç”»ã‚’å‰Šé™¤";
                    delBtn.onclick = async (e) => {
                        e.preventDefault();
                        if(confirm("ã“ã®å‹•ç”»ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) {
                            await deleteDoc(doc(db, "videos", vId));
                            alert("å‰Šé™¤ã—ã¾ã—ãŸ");
                        }
                    };
                    wrapper.appendChild(delBtn);
                }

                grid.appendChild(wrapper);

                // ã‚µãƒ ãƒã‚¤ãƒ«å‡¦ç†
                const img = document.getElementById(sid);
                if(vd.thumbnail) { img.src = vd.thumbnail; img.style.opacity = 1; }
                else { generateThumb(vd.url, img); }

                // æŠ•ç¨¿è€…ã‚¢ã‚¤ã‚³ãƒ³è¡¨ç¤º
                const uSnap = await getDoc(doc(db, "users", vd.userId));
                if(uSnap.exists()) document.getElementById(`icon-${vId}`).src = uSnap.data().icon || "";
            });
        });
    }
</script>
</body>
</html>

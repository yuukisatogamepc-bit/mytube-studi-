<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MyTube - „Éõ„Éº„É†</title>
    <style>
        :root { --yt-bg: #ffffff; --yt-text: #0f0f0f; --yt-gray: #606060; --yt-card: #f2f2f2; }
        body { font-family: "Roboto", Arial, sans-serif; margin: 0; background: var(--yt-bg); color: var(--yt-text); -webkit-tap-highlight-color: transparent; }
        
        header { 
            display: flex; align-items: center; justify-content: space-between; 
            padding: 10px 15px; background: var(--yt-bg); border-bottom: 1px solid #ddd; 
            position: sticky; top: 0; z-index: 100; height: 40px;
        }
        .logo { color: #ff0000; font-size: 20px; font-weight: bold; cursor: pointer; text-decoration: none; }
        
        .header-btns { display: flex; align-items: center; gap: 12px; }
        .icon-btn { background: none; border: none; font-size: 20px; cursor: pointer; padding: 5px; }
        
        /* „É≠„Ç∞„Ç§„É≥„Éª„É≠„Ç∞„Ç¢„Ç¶„ÉàÁî®„Çπ„Çø„Ç§„É´ */
        .auth-btn { 
            background: none; border: 1px solid #065fd4; color: #065fd4; 
            padding: 6px 12px; border-radius: 20px; font-weight: bold; cursor: pointer; font-size: 14px;
        }
        .user-chip { width: 32px; height: 32px; border-radius: 50%; cursor: pointer; object-fit: cover; background: #eee; }

        #videoGrid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
            gap: 20px; padding: 15px; max-width: 1400px; margin: 0 auto; 
        }
        @media (max-width: 600px) { 
            #videoGrid { grid-template-columns: 1fr; padding: 0; gap: 10px; } 
            .v-card { border-radius: 0; }
            .v-thumb-container { border-radius: 0; }
        }

        .v-card { cursor: pointer; transition: 0.2s; }
        .v-thumb-container { 
            width: 100%; aspect-ratio: 16/9; border-radius: 12px; 
            background: #eee; overflow: hidden; position: relative; 
        }
        .v-thumb { width: 100%; height: 100%; object-fit: cover; opacity: 0; transition: opacity 0.3s; }
        
        .v-info { display: flex; gap: 12px; padding: 12px; }
        .c-icon-s { width: 36px; height: 36px; border-radius: 50%; background: #eee; flex-shrink: 0; object-fit: cover; }
        .v-text { overflow: hidden; }
        .v-title { font-weight: bold; font-size: 16px; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; margin-bottom: 4px; }
        .v-meta { color: var(--yt-gray); font-size: 13px; }
    </style>
</head>
<body>

<header>
    <a href="index.html" class="logo">MyTube</a>
    <div class="header-btns" id="authContainer">
        <button class="auth-btn" onclick="location.href='login.html'">„É≠„Ç∞„Ç§„É≥</button>
    </div>
</header>

<div id="videoGrid"></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, onSnapshot, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAZivYKOGc1tSUAIDq_c10C1wJ-Pdh0U2o",
        authDomain: "mytube-f4544.firebaseapp.com",
        projectId: "mytube-f4544",
        storageBucket: "mytube-f4544.firebasestorage.app",
        messagingSenderId: "655444283107",
        appId: "1:655444283107:web:04f9173faf2d951790ffd6"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // „É≠„Ç∞„Ç§„É≥Áä∂ÊÖã„ÅÆÁõ£Ë¶ñ„Å®„Éú„Çø„É≥„ÅÆÂàá„ÇäÊõø„Åà
    onAuthStateChanged(auth, async (user) => {
        const container = document.getElementById('authContainer');
        if (user) {
            const uSnap = await getDoc(doc(db, "users", user.uid));
            const userData = uSnap.data();
            container.innerHTML = `
                <button class="icon-btn" onclick="location.href='upload.html'">üì§</button>
                <img src="${userData?.icon || ''}" class="user-chip" onclick="if(confirm('„É≠„Ç∞„Ç¢„Ç¶„Éà„Åó„Åæ„Åô„ÅãÔºü')) window.handleSignOut()" title="„É≠„Ç∞„Ç¢„Ç¶„Éà">
            `;
        } else {
            container.innerHTML = `<button class="auth-btn" onclick="location.href='login.html'">„É≠„Ç∞„Ç§„É≥</button>`;
        }
    });

    window.handleSignOut = () => {
        signOut(auth).then(() => {
            alert("„É≠„Ç∞„Ç¢„Ç¶„Éà„Åó„Åæ„Åó„Åü");
            location.reload();
        });
    };

    // „Çµ„É†„Éç„Ç§„É´ÁîüÊàêÈñ¢Êï∞ (ÂâçÂõûÂêåÊßò)
    async function generateThumb(url, imgElement) {
        const video = document.createElement('video');
        video.src = url; video.preload = "auto"; video.muted = true; video.playsInline = true; video.crossOrigin = "anonymous"; 
        video.addEventListener('loadeddata', () => { video.currentTime = 1.0; });
        video.addEventListener('seeked', () => {
            try {
                const canvas = document.createElement('canvas');
                canvas.width = 480; canvas.height = 270;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                imgElement.src = canvas.toDataURL('image/jpeg', 0.8);
                imgElement.style.opacity = 1;
                video.remove();
            } catch (e) { setTimeout(() => { video.currentTime = 1.5; }, 500); }
        });
        setTimeout(() => { if (imgElement.style.opacity === "0") { imgElement.src = "https://via.placeholder.com/480x270?text=MyTube"; imgElement.style.opacity = 1; } }, 8000);
        video.load();
    }

    // ÂãïÁîª‰∏ÄË¶ß„ÅÆÂèñÂæó
    onSnapshot(collection(db, "videos"), snap => {
        const grid = document.getElementById('videoGrid');
        grid.innerHTML = "";
        snap.forEach(async vDoc => {
            const vd = vDoc.data();
            const thumbId = `home-thumb-${vDoc.id}`;
            const iconId = `home-icon-${vDoc.id}`;
            const card = document.createElement('div');
            card.className = "v-card";
            card.onclick = () => location.href = `watch.html?id=${vDoc.id}`;
            card.innerHTML = `
                <div class="v-thumb-container"><img src="" class="v-thumb" id="${thumbId}"></div>
                <div class="v-info">
                    <img src="" class="c-icon-s" id="${iconId}">
                    <div class="v-text">
                        <div class="v-title">${vd.title || 'ÁÑ°È°å„ÅÆÂãïÁîª'}</div>
                        <div class="v-meta"><span id="name-${vDoc.id}">...</span> ‚Ä¢ ${(vd.views || 0).toLocaleString()} ÂõûË¶ñËÅ¥</div>
                    </div>
                </div>
            `;
            grid.appendChild(card);

            getDoc(doc(db, "users", vd.userId)).then(uSnap => {
                if(uSnap.exists()){
                    const ud = uSnap.data();
                    document.getElementById(`name-${vDoc.id}`).innerText = ud.name;
                    document.getElementById(iconId).src = ud.icon || "";
                }
            });

            const img = document.getElementById(thumbId);
            if (vd.thumbnail) { img.src = vd.thumbnail; img.style.opacity = 1; }
            else { generateThumb(vd.url, img); }
        });
    });
</script>
</body>
</html>

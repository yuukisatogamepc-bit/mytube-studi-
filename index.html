<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iroTube - ホーム</title>
    <style>
        :root { --iro-blue: #007bff; --tube-yellow: #ffcc00; --yt-bg: #fff; --yt-gray: #606060; }
        body { font-family: "Roboto", Arial, sans-serif; margin: 0; background: var(--yt-bg); color: #0f0f0f; }

        /* ヘッダーデザイン */
        header { 
            display: flex; align-items: center; justify-content: space-between;
            padding: 10px 20px; position: sticky; top: 0; background: #fff; z-index: 100;
        }
        .header-logo { font-size: 24px; font-weight: bold; cursor: pointer; text-decoration: none; }
        .logo-iro { color: var(--iro-blue); }
        .logo-tube { color: #000; background: var(--tube-yellow); padding: 2px 6px; border-radius: 4px; margin-left: 2px; }

        .btn-upload { background: #f2f2f2; border: none; padding: 8px 16px; border-radius: 20px; font-weight: bold; cursor: pointer; text-decoration: none; color: #000; font-size: 14px; }
        .btn-upload:hover { background: #e5e5e5; }

        /* 動画グリッド */
        .v-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            padding: 20px;
            max-width: 1500px;
            margin: 0 auto;
        }
        .v-card { text-decoration: none; color: inherit; display: block; }
        .thumb-box { 
            width: 100%; aspect-ratio: 16/9; border-radius: 12px; 
            background: #eee; overflow: hidden; position: relative; 
        }
        .thumb-img { width: 100%; height: 100%; object-fit: cover; opacity: 0; transition: opacity 0.3s; }
        
        .v-info { display: flex; gap: 12px; margin-top: 12px; }
        .u-icon { width: 36px; height: 36px; border-radius: 50%; background: #eee; flex-shrink: 0; object-fit: cover; }
        .v-details { min-width: 0; }
        .v-title { font-weight: bold; font-size: 16px; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; margin-bottom: 4px; }
        .v-meta { font-size: 14px; color: var(--yt-gray); }

        @media (max-width: 500px) { .v-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<header>
    <a href="index.html" class="header-logo">
        <span class="logo-iro">iro</span><span class="logo-tube">Tube</span>
    </a>
    <a href="upload.html" class="btn-upload">動画を投稿</a>
</header>

<div class="v-grid" id="videoGrid">
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, query, orderBy, onSnapshot, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAZivYKOGc1tSUAIDq_c10C1wJ-Pdh0U2o",
        authDomain: "mytube-f4544.firebaseapp.com",
        projectId: "mytube-f4544",
        storageBucket: "mytube-f4544.firebasestorage.app",
        messagingSenderId: "655444283107",
        appId: "1:655444283107:web:04f9173faf2d951790ffd6"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    function loadAllVideos() {
        const q = query(collection(db, "videos"), orderBy("createdAt", "desc"));
        onSnapshot(q, snap => {
            const grid = document.getElementById('videoGrid');
            grid.innerHTML = "";
            snap.forEach(vDoc => {
                const vd = vDoc.data();
                const vid = vDoc.id;
                const tid = `thumb-${vid}`;
                const uid = `uicon-${vid}`;

                const card = document.createElement('a');
                card.className = "v-card";
                card.href = `watch.html?id=${vid}`;
                card.innerHTML = `
                    <div class="thumb-box"><img src="" id="${tid}" class="thumb-img"></div>
                    <div class="v-info">
                        <img src="" id="${uid}" class="u-icon">
                        <div class="v-details">
                            <div class="v-title">${vd.title}</div>
                            <div class="v-meta" id="meta-${vid}">読み込み中...</div>
                        </div>
                    </div>
                `;
                grid.appendChild(card);

                // 投稿者情報と視聴回数の取得
                getDoc(doc(db, "users", vd.userId)).then(uSnap => {
                    const ud = uSnap.data();
                    if(ud) {
                        document.getElementById(uid).src = ud.icon || "";
                        document.getElementById(`meta-${vid}`).innerText = `${ud.name} • ${(vd.views || 0).toLocaleString()} 回視聴`;
                    }
                });

                // サムネイル処理
                setTimeout(() => {
                    const img = document.getElementById(tid);
                    if(vd.thumbnail) {
                        img.src = vd.thumbnail;
                        img.style.opacity = 1;
                    } else {
                        generateThumb(vd.url, img);
                    }
                }, 100);
            });
        });
    }

    function generateThumb(url, imgElement) {
        const video = document.createElement('video');
        video.src = url;
        video.preload = "auto";
        video.muted = true;
        video.crossOrigin = "anonymous";
        video.onloadeddata = () => video.currentTime = 1.0;
        video.onseeked = () => {
            const canvas = document.createElement('canvas');
            canvas.width = 320;
            canvas.height = 180;
            canvas.getContext('2d').drawImage(video, 0, 0, 320, 180);
            imgElement.src = canvas.toDataURL('image/jpeg');
            imgElement.style.opacity = 1;
        };
    }

    loadAllVideos();
</script>
</body>
</html>

<style>
    /* ...これまでのスタイルは維持... */
    .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
    .modal-content { background: white; margin: 10% auto; padding: 20px; border-radius: 15px; width: 300px; text-align: center; }
    .modal-content input { width: 90%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px; }
    .save-btn { background: #00b300; color: white; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; }
</style>

<div id="profileModal" class="modal">
    <div class="modal-content">
        <h3>プロフィール変更</h3>
        <input type="text" id="editName" placeholder="新しい名前">
        <input type="text" id="editIcon" placeholder="アイコン画像URL (任意)">
        <button class="save-btn" onclick="saveProfile()">保存する</button>
        <button onclick="document.getElementById('profileModal').style.display='none'" style="background:none; border:none; color:gray; cursor:pointer; margin-top:10px;">キャンセル</button>
    </div>
</div>

<script type="module">
    // ...Firebase設定は維持...
    import { getFirestore, doc, getDoc, setDoc, collection, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const auth = getAuth();
    const db = getFirestore();
    let currentUser = null;

    onAuthStateChanged(auth, async (user) => {
        currentUser = user;
        const area = document.getElementById('userArea');
        if (user) {
            // Firestoreから最新のプロフィールを取得
            const userDoc = await getDoc(doc(db, "users", user.uid));
            let userData = userDoc.exists() ? userDoc.data() : { name: user.displayName, icon: user.photoURL };

            area.innerHTML = `
                <a href="upload.html" class="btn-upload">投稿</a>
                <img src="${userData.icon}" class="user-icon" onclick="openProfileModal('${userData.name}', '${userData.icon}')" style="cursor:pointer" title="プロフィールを変更">
                <button onclick="logout()" style="background:none; border:none; cursor:pointer; font-size:12px;">ログアウト</button>
            `;
        } else {
            area.innerHTML = `<button onclick="login()">ログイン</button>`;
        }
        loadVideos(user);
    });

    window.openProfileModal = (name, icon) => {
        document.getElementById('editName').value = name;
        document.getElementById('editIcon').value = icon;
        document.getElementById('profileModal').style.display = 'block';
    };

    window.saveProfile = async () => {
        if (!currentUser) return;
        const newName = document.getElementById('editName').value;
        const newIcon = document.getElementById('editIcon').value;

        await setDoc(doc(db, "users", currentUser.uid), {
            name: newName,
            icon: newIcon,
            uid: currentUser.uid
        }, { merge: true });

        alert("プロフィールを更新しました！");
        location.reload(); // 反映のために再読み込み
    };
    // ...loadVideos関数などは維持...
</script>

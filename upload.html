<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>再生 - Mvideo</title>
    <style>
        body { font-family: sans-serif; margin: 0; background: #fff; display: flex; flex-direction: column; align-items: center; }
        header { width: 100%; padding: 10px 20px; border-bottom: 1px solid #eee; box-sizing: border-box; }
        .logo { font-size: 22px; font-weight: bold; text-decoration: none; color: #ff0000; }
        .container { display: flex; max-width: 1200px; width: 100%; gap: 20px; padding: 20px; box-sizing: border-box; }
        .main-col { flex: 2; }
        /* 動画プレイヤーのサイズと背景 */
        video { width: 100%; aspect-ratio: 16/9; background: #000; border-radius: 12px; outline: none; }
        .v-title { font-size: 20px; font-weight: bold; margin: 15px 0; }
        .author-info { display: flex; align-items: center; gap: 10px; }
        .author-icon { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        .btn-sub { background: #ff0000; color: #fff; padding: 8px 16px; border-radius: 20px; border: none; font-weight: bold; cursor: pointer; }
        .admin-badge { color: #ff0000; font-weight: bold; margin-left: 4px; }
        .official-badge { color: #007bff; font-weight: bold; margin-left: 4px; }
        .stat-val { font-weight: bold; }
        .comment-item { margin-bottom: 15px; border-bottom: 1px solid #f9f9f9; padding-bottom: 10px; }
    </style>
</head>
<body>
<header><a href="index.html" class="logo">Mvideo</a></header>
<div class="container">
    <div class="main-col">
        <video id="player" controls playsinline></video>
        <div id="vTitle" class="v-title">読み込み中...</div>
        <div style="font-size:14px; color:#606060; margin-bottom:10px;">再生回数 <span id="viewNum" class="stat-val">0</span>回</div>
        <div class="author-info">
            <img id="authorIcon" class="author-icon">
            <div>
                <div id="authorName" style="font-weight:bold;">読み込み中...</div>
                <div style="font-size:12px; color:#606060;">登録者 <span id="subNum" class="stat-val">0</span>人</div>
            </div>
            <button class="btn-sub" id="subBtn">チャンネル登録</button>
        </div>
        <div id="commentList" style="margin-top:20px;"></div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, getDoc, collection, query, orderBy, onSnapshot, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = { 
        apiKey: "AIzaSyAZivYKOGc1tSUAIDq_c10C1wJ-Pdh0U2o", 
        authDomain: "mytube-f4544.firebaseapp.com", 
        projectId: "mytube-f4544", 
        storageBucket: "mytube-f4544.firebasestorage.app", 
        messagingSenderId: "655444283107", 
        appId: "1:655444283107:web:04f9173faf2d951790ffd6" 
    };
    
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const vid = new URLSearchParams(window.location.search).get("id");
    
    const ADMIN_UID = "tP5CqCTRO3f2QQ8jdoj0ftY8kZU2";
    const OFFICIAL_UID = "UUgBXquGY5O2iDADKpwNUU0i5Ct2";

    function getBadge(uid) {
        if(uid === ADMIN_UID) return '<span class="admin-badge">[運営]</span>';
        if(uid === OFFICIAL_UID) return '<span class="official-badge">[公式]</span>';
        return '';
    }

    async function load() {
        if(!vid) return;
        
        const vRef = doc(db, "videos", vid);
        const vSnap = await getDoc(vRef);
        
        if (vSnap.exists()) {
            const v = vSnap.data();
            const player = document.getElementById('player');
            
            // CloudinaryのURLを確実にセット
            player.src = v.url;
            player.load(); // 動画ソースの再読み込みを強制

            document.getElementById('vTitle').innerText = v.title;
            document.getElementById('viewNum').innerText = v.views || 0;
            
            // 再生回数をカウントアップ
            await updateDoc(vRef, { views: increment(1) });

            // 投稿者情報の取得
            const uSnap = await getDoc(doc(db, "users", v.userId));
            if (uSnap.exists()) {
                const userData = uSnap.data();
                document.getElementById('authorName').innerHTML = (userData.name || "不明") + getBadge(v.userId);
                document.getElementById('authorIcon').src = userData.icon || "";
                document.getElementById('subNum').innerText = userData.subscribers || 0;
            }

            // コメントのリアルタイム取得
            onSnapshot(query(collection(db, "videos", vid, "comments"), orderBy("createdAt", "desc")), snap => {
                const list = document.getElementById('commentList');
                list.innerHTML = "<h3>コメント</h3>";
                snap.forEach(d => {
                    const c = d.data();
                    list.innerHTML += `<div class="comment-item"><strong>${c.userName || '匿名'}${getBadge(c.userId)}</strong>: ${c.text}</div>`;
                });
            });
        } else {
            document.getElementById('vTitle').innerText = "動画が見つかりません。";
        }
    }

    load();
</script>
</body>
</html>

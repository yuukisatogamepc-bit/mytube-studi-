<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>動画投稿 - Mvideo</title>
    <style>
        body { font-family: sans-serif; margin: 0; background: #fff; display: flex; flex-direction: column; align-items: center; }
        header { width: 100%; padding: 10px 20px; border-bottom: 1px solid #eee; box-sizing: border-box; }
        .logo { font-size: 22px; font-weight: bold; text-decoration: none; color: #ff0000; }
        
        .container { max-width: 600px; width: 100%; padding: 40px 20px; box-sizing: border-box; }
        h2 { margin-bottom: 30px; }
        
        .input-group { margin-bottom: 20px; text-align: left; }
        label { display: block; font-size: 14px; color: #606060; margin-bottom: 8px; font-weight: bold; }
        input[type="text"] { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        
        .file-box { border: 2px dashed #ddd; padding: 20px; border-radius: 8px; text-align: center; cursor: pointer; transition: 0.2s; margin-bottom: 10px; }
        .file-box:hover { border-color: #ff0000; background: #fffafa; }
        .preview-img { width: 100%; max-height: 200px; object-fit: cover; margin-top: 10px; display: none; border-radius: 8px; }
        
        .btn-upload { width: 100%; padding: 15px; border-radius: 30px; border: none; background: #ff0000; color: #fff; font-weight: bold; font-size: 16px; cursor: pointer; margin-top: 20px; }
        .btn-upload:disabled { background: #ccc; cursor: not-allowed; }
        
        .loading { font-size: 14px; color: #ff0000; margin-top: 10px; display: none; font-weight: bold; }
        .video-preview { width: 100%; border-radius: 8px; margin-top: 10px; display: none; }
    </style>
</head>
<body>

<header>
    <a href="index.html" class="logo">Mvideo</a>
</header>

<div class="container">
    <h2>動画を投稿する</h2>
    
    <div class="input-group">
        <label>タイトル</label>
        <input type="text" id="vTitle" placeholder="動画のタイトルを入力">
    </div>

    <div class="input-group">
        <label>動画ファイル (mp4, movなど)</label>
        <div class="file-box" onclick="document.getElementById('videoInput').click()">
            <span id="videoStatus">動画を選択してください</span>
            <input type="file" id="videoInput" accept="video/*" style="display:none">
            <video id="videoPreview" class="video-preview" controls></video>
        </div>
        <div id="videoUploadMsg" class="loading">動画をCloudinaryにアップロード中...</div>
    </div>

    <div class="input-group">
        <label>サムネイル画像</label>
        <div class="file-box" onclick="document.getElementById('thumbInput').click()">
            <span id="thumbStatus">サムネイルを選択してください</span>
            <input type="file" id="thumbInput" accept="image/*" style="display:none">
            <img id="thumbPreview" class="preview-img">
        </div>
        <div id="thumbUploadMsg" class="loading">サムネイルをアップロード中...</div>
    </div>

    <button class="btn-upload" id="submitBtn">公開する</button>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const CLOUD_NAME = "du5blunb0"; 
    const UPLOAD_PRESET = "mytube_preset"; 

    const firebaseConfig = {
        apiKey: "AIzaSyAZivYKOGc1tSUAIDq_c10C1wJ-Pdh0U2o",
        authDomain: "mytube-f4544.firebaseapp.com",
        projectId: "mytube-f4544",
        storageBucket: "mytube-f4544.firebasestorage.app",
        messagingSenderId: "655444283107",
        appId: "1:655444283107:web:04f9173faf2d951790ffd6"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let currentUser = null;
    let videoCloudinaryUrl = "";
    let thumbnailCloudinaryUrl = "";

    onAuthStateChanged(auth, user => {
        if (!user) {
            alert("ログインが必要です");
            location.href = "login.html";
        }
        currentUser = user;
    });

    // 汎用アップロード関数 (Cloudinary用)
    async function uploadToCloudinary(file, type) {
        const formData = new FormData();
        formData.append("file", file);
        formData.append("upload_preset", UPLOAD_PRESET);
        formData.append("resource_type", type); // 'video' または 'image'

        const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/${type}/upload`, {
            method: "POST",
            body: formData
        });
        return await res.json();
    }

    // 動画ファイル選択時の処理
    document.getElementById('videoInput').onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const msg = document.getElementById('videoUploadMsg');
        const btn = document.getElementById('submitBtn');
        const status = document.getElementById('videoStatus');
        
        msg.style.display = 'block';
        btn.disabled = true;

        try {
            const data = await uploadToCloudinary(file, "video");
            if (data.secure_url) {
                videoCloudinaryUrl = data.secure_url;
                const vPreview = document.getElementById('videoPreview');
                vPreview.src = videoCloudinaryUrl;
                vPreview.style.display = 'block';
                status.innerText = "動画を変更する";
            }
        } catch (error) {
            alert("動画のアップロードに失敗しました");
        } finally {
            msg.style.display = 'none';
            btn.disabled = false;
        }
    };

    // サムネイルファイル選択時の処理
    document.getElementById('thumbInput').onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const msg = document.getElementById('thumbUploadMsg');
        const btn = document.getElementById('submitBtn');
        const status = document.getElementById('thumbStatus');

        msg.style.display = 'block';
        btn.disabled = true;

        try {
            const data = await uploadToCloudinary(file, "image");
            if (data.secure_url) {
                thumbnailCloudinaryUrl = data.secure_url;
                const img = document.getElementById('thumbPreview');
                img.src = thumbnailCloudinaryUrl;
                img.style.display = 'block';
                status.innerText = "サムネイルを変更する";
            }
        } catch (error) {
            alert("サムネイルのアップロードに失敗しました");
        } finally {
            msg.style.display = 'none';
            btn.disabled = false;
        }
    };

    // 公開処理
    document.getElementById('submitBtn').onclick = async () => {
        const title = document.getElementById('vTitle').value;

        if (!title) return alert("タイトルを入力してください");
        if (!videoCloudinaryUrl) return alert("動画をアップロードしてください");
        if (!thumbnailCloudinaryUrl) return alert("サムネイルをアップロードしてください");

        try {
            await addDoc(collection(db, "videos"), {
                title: title,
                url: videoCloudinaryUrl,
                thumbnail: thumbnailCloudinaryUrl,
                userId: currentUser.uid,
                views: 0,
                likes: 0,
                createdAt: serverTimestamp()
            });
            alert("公開完了しました！");
            location.href = "index.html";
        } catch (e) {
            alert("エラーが発生しました");
        }
    };
</script>
</body>
</html>

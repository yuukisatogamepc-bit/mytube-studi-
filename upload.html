<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>動画投稿 - iroTube</title>
    <style>
        body { font-family: sans-serif; margin: 0; padding: 20px; background: #fff; }
        .header-logo { font-size: 24px; font-weight: bold; text-decoration: none; display: flex; align-items: center; margin-bottom: 30px; }
        .iro { color: #007bff; }
        .tube { color: #000; background: #ffcc00; padding: 2px 6px; border-radius: 4px; margin-left: 2px; }
        
        .upload-card { max-width: 500px; margin: 0 auto; border: 1px solid #eee; padding: 20px; border-radius: 12px; }
        input, button { width: 100%; padding: 10px; margin-top: 10px; box-sizing: border-box; }
        button { background: #007bff; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        button:disabled { background: #ccc; cursor: not-allowed; }

        /* 進捗バーのスタイル */
        #progressContainer { display: none; margin-top: 20px; text-align: center; }
        .progress-bg { background: #eee; border-radius: 10px; height: 10px; width: 100%; overflow: hidden; margin-top: 5px; }
        .progress-bar { background: #007bff; height: 100%; width: 0%; transition: width 0.2s; }
        #statusText { font-size: 14px; color: #666; }
    </style>
</head>
<body>

<a href="index.html" class="header-logo">
    <span class="iro">iro</span><span class="tube">Tube</span>
</a>

<div class="upload-card">
    <h2>動画をアップロード</h2>
    <input type="text" id="title" placeholder="動画のタイトル">
    <label style="display:block; margin-top:15px; font-size:14px;">動画ファイルを選択:</label>
    <input type="file" id="videoFile" accept="video/*">
    
    <button id="uploadBtn">投稿する</button>

    <div id="progressContainer">
        <div id="statusText">準備中... 0%</div>
        <div class="progress-bg">
            <div id="progressBar" class="progress-bar"></div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAZivYKOGc1tSUAIDq_c10C1wJ-Pdh0U2o",
        authDomain: "mytube-f4544.firebaseapp.com",
        projectId: "mytube-f4544",
        storageBucket: "mytube-f4544.firebasestorage.app",
        messagingSenderId: "655444283107",
        appId: "1:655444283107:web:04f9173faf2d951790ffd6"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);
    const auth = getAuth(app);

    let currentUser = null;
    onAuthStateChanged(auth, user => {
        currentUser = user;
        if (!user) { alert("ログインが必要です"); location.href = "login.html"; }
    });

    document.getElementById('uploadBtn').onclick = async () => {
        const title = document.getElementById('title').value;
        const file = document.getElementById('videoFile').files[0];
        if (!title || !file || !currentUser) return alert("入力が足りません");

        const btn = document.getElementById('uploadBtn');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const statusText = document.getElementById('statusText');

        btn.disabled = true;
        progressContainer.style.display = 'block';

        const storageRef = ref(storage, `videos/${Date.now()}_${file.name}`);
        const uploadTask = uploadBytesResumable(storageRef, file);

        // アップロードの監視
        uploadTask.on('state_changed', 
            (snapshot) => {
                const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                const roundedProgress = Math.round(progress);
                progressBar.style.width = roundedProgress + '%';
                statusText.innerText = `アップロード中... ${roundedProgress}%`;
            }, 
            (error) => {
                console.error(error);
                alert("アップロードに失敗しました");
                btn.disabled = false;
            }, 
            async () => {
                // 完了時
                const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
                await addDoc(collection(db, "videos"), {
                    title: title,
                    url: downloadURL,
                    userId: currentUser.uid,
                    views: 0,
                    createdAt: serverTimestamp()
                });
                alert("投稿が完了しました！");
                location.href = "index.html";
            }
        );
    };
</script>
</body>
</html>

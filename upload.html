<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>プロフィール - Mvideo</title>
    <style>
        body { font-family: sans-serif; margin: 0; background: #fff; display: flex; flex-direction: column; align-items: center; }
        header { width: 100%; padding: 10px 20px; border-bottom: 1px solid #eee; box-sizing: border-box; }
        .logo { font-size: 22px; font-weight: bold; text-decoration: none; color: #ff0000; }
        .container { max-width: 500px; width: 100%; padding: 40px 20px; text-align: center; }
        .u-icon { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; background: #eee; margin-bottom: 20px; }
        .btn-save { width: 100%; padding: 12px; border-radius: 25px; background: #ff0000; color: #fff; border: none; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>
<header><a href="index.html" class="logo">Mvideo</a></header>
<div class="container">
    <img id="displayIcon" class="u-icon">
    <input type="file" id="fileInput" accept="image/*" style="display:none">
    <button onclick="document.getElementById('fileInput').click()" style="display:block; margin: 0 auto 20px;">アイコンを選択</button>
    <input type="text" id="userNameInput" placeholder="名前" style="width:100%; padding:10px; margin-bottom:20px;">
    <button class="btn-save" id="saveBtn">保存</button>
    <button onclick="auth.signOut().then(()=>location.href='index.html')" style="margin-top:20px; background:none; border:none; color:gray; cursor:pointer;">ログアウト</button>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const CLOUD_NAME = "du5blunb0", UPLOAD_PRESET = "mytube_preset";
    const firebaseConfig = { apiKey: "AIzaSyAZivYKOGc1tSUAIDq_c10C1wJ-Pdh0U2o", authDomain: "mytube-f4544.firebaseapp.com", projectId: "mytube-f4544", storageBucket: "mytube-f4544.firebasestorage.app", messagingSenderId: "655444283107", appId: "1:655444283107:web:04f9173faf2d951790ffd6" };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let uid = null, iconUrl = "";
    onAuthStateChanged(auth, async (user) => {
        if(user) {
            uid = user.uid;
            const uSnap = await getDoc(doc(db, "users", uid));
            if(uSnap.exists()) {
                document.getElementById('userNameInput').value = uSnap.data().name;
                iconUrl = uSnap.data().icon;
                document.getElementById('displayIcon').src = iconUrl;
            }
        }
    });

    document.getElementById('fileInput').onchange = async (e) => {
        const formData = new FormData();
        formData.append("file", e.target.files[0]);
        formData.append("upload_preset", UPLOAD_PRESET);
        const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, { method: "POST", body: formData });
        const data = await res.json();
        iconUrl = data.secure_url;
        document.getElementById('displayIcon').src = iconUrl;
    };

    document.getElementById('saveBtn').onclick = async () => {
        await setDoc(doc(db, "users", uid), { name: document.getElementById('userNameInput').value, icon: iconUrl }, { merge: true });
        alert("保存完了");
    };
</script>
</body>
</html>

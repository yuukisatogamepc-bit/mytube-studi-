<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAZivYKOGc1tSUAIDq_c10C1wJ-Pdh0U2o",
        authDomain: "mytube-f4544.firebaseapp.com",
        projectId: "mytube-f4544",
        storageBucket: "mytube-f4544.firebasestorage.app",
        messagingSenderId: "655444283107",
        appId: "1:655444283107:web:04f9173faf2d951790ffd6"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    window.uploadVideo = async function() {
        const file = document.getElementById('videoFile').files[0];
        const title = document.getElementById('videoTitle').value;
        const status = document.getElementById('status');
        const bar = document.getElementById('bar');
        const barBg = document.getElementById('barBg');
        const btn = document.getElementById('btn');

        if (!file || !title) return alert("タイトルと動画を選んでね！");

        btn.disabled = true;
        barBg.style.display = 'block';
        status.innerText = "長い動画を準備中...";

        // 1回に送るサイズを10MBに設定（安定性重視）
        const chunkSize = 10 * 1024 * 1024; 
        const totalChunks = Math.ceil(file.size / chunkSize);
        const uniqueUploadId = 'id_' + Date.now();
        let videoUrl = "";

        try {
            for (let i = 0; i < totalChunks; i++) {
                const start = i * chunkSize;
                const end = Math.min(file.size, start + chunkSize);
                const chunk = file.slice(start, end);

                const formData = new FormData();
                formData.append("file", chunk);
                formData.append("upload_preset", "mytube_preset"); // プリセット名を確認！

                const contentRange = `bytes ${start}-${end - 1}/${file.size}`;

                const response = await fetch("https://api.cloudinary.com/v1_1/du5blunb0/video/upload", {
                    method: "POST",
                    body: formData,
                    headers: {
                        "X-Unique-Upload-Id": uniqueUploadId,
                        "Content-Range": contentRange
                    }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error.message);
                }

                const result = await response.json();
                const progress = Math.round(((i + 1) / totalChunks) * 100);
                bar.style.width = progress + "%";
                status.innerText = `アップロード中: ${progress}% (${i+1}/${totalChunks})`;

                if (i === totalChunks - 1) videoUrl = result.secure_url;
            }

            if (videoUrl) {
                status.innerText = "Firebaseに保存中...";
                await addDoc(collection(db, "videos"), {
                    title: title,
                    url: videoUrl,
                    createdAt: serverTimestamp()
                });
                status.innerHTML = "<b style='color:green;'>✅ 公開完了しました！</b>";
            }
        } catch (e) {
            console.error(e);
            status.innerText = "❌ エラー: " + e.message;
            btn.disabled = false;
        }
    };
</script>

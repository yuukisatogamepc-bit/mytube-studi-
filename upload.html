<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>動画投稿 - Mvideo</title>
    <style>
        body { font-family: sans-serif; margin: 0; background: #fff; display: flex; flex-direction: column; align-items: center; }
        header { width: 100%; padding: 10px 20px; border-bottom: 1px solid #eee; box-sizing: border-box; }
        .logo { font-size: 22px; font-weight: bold; text-decoration: none; color: #ff0000; }
        .container { max-width: 600px; width: 100%; padding: 40px 20px; }
        .file-box { border: 2px dashed #ddd; padding: 20px; border-radius: 8px; text-align: center; cursor: pointer; margin-bottom: 20px; }
        .btn-upload { width: 100%; padding: 15px; border-radius: 30px; background: #ff0000; color: #fff; font-weight: bold; border: none; cursor: pointer; }
        .loading { color: #ff0000; font-weight: bold; display: none; margin: 10px 0; }
        input[type="text"] { width: 100%; padding: 12px; margin-bottom: 20px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
    </style>
</head>
<body>
<header><a href="index.html" class="logo">Mvideo</a></header>
<div class="container">
    <h2>動画を投稿する</h2>
    <input type="text" id="vTitle" placeholder="動画のタイトル">
    
    <div class="file-box" onclick="document.getElementById('videoInput').click()">
        <span id="vStatus">動画ファイルを選択 (最大100MB以上対応)</span>
        <input type="file" id="videoInput" accept="video/*" style="display:none">
    </div>
    <div id="vLoading" class="loading">動画アップロード中...</div>

    <div class="file-box" onclick="document.getElementById('thumbInput').click()">
        <span id="tStatus">サムネイル画像を選択</span>
        <input type="file" id="thumbInput" accept="image/*" style="display:none">
    </div>
    <div id="tLoading" class="loading">サムネイルアップロード中...</div>

    <button class="btn-upload" id="submitBtn">公開する</button>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const CLOUD_NAME = "du5blunb0"; 
    const UPLOAD_PRESET = "mytube_preset";
    const firebaseConfig = { apiKey: "AIzaSyAZivYKOGc1tSUAIDq_c10C1wJ-Pdh0U2o", authDomain: "mytube-f4544.firebaseapp.com", projectId: "mytube-f4544", storageBucket: "mytube-f4544.firebasestorage.app", messagingSenderId: "655444283107", appId: "1:655444283107:web:04f9173faf2d951790ffd6" };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let currentUser = null, videoUrl = "", thumbUrl = "";
    onAuthStateChanged(auth, user => { currentUser = user; });

    async function upload(file, type) {
        const formData = new FormData();
        formData.append("file", file);
        formData.append("upload_preset", UPLOAD_PRESET);
        // 大容量対応のため、大きなファイルは自動的にチャンク処理される設定で送信
        const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/${type}/upload`, {
            method: "POST",
            body: formData
        });
        return await res.json();
    }

    document.getElementById('videoInput').onchange = async (e) => {
        const file = e.target.files[0];
        document.getElementById('vLoading').style.display = 'block';
        const data = await upload(file, "video");
        videoUrl = data.secure_url;
        document.getElementById('vLoading').innerText = "動画アップロード完了！";
    };

    document.getElementById('thumbInput').onchange = async (e) => {
        const file = e.target.files[0];
        document.getElementById('tLoading').style.display = 'block';
        const data = await upload(file, "image");
        thumbUrl = data.secure_url;
        document.getElementById('tLoading').innerText = "サムネイルアップロード完了！";
    };

    document.getElementById('submitBtn').onclick = async () => {
        const title = document.getElementById('vTitle').value;
        if(!title || !videoUrl || !thumbUrl) return alert("全て入力してください");
        await addDoc(collection(db, "videos"), {
            title, url: videoUrl, thumbnail: thumbUrl, userId: currentUser.uid, views: 0, createdAt: serverTimestamp()
        });
        location.href = "index.html";
    };
</script>
</body>
</html>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  // --- あなたのFirebase設定 ---
  const firebaseConfig = {
    apiKey: "AIzaSyAZivYKOGc1tSUAIDq_c10C1wJ-Pdh0U2o",
    authDomain: "mytube-f4544.firebaseapp.com",
    projectId: "mytube-f4544",
    storageBucket: "mytube-f4544.firebasestorage.app",
    messagingSenderId: "655444283107",
    appId: "1:655444283107:web:04f9173faf2d951790ffd6"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // --- あなたのCloudinary設定 ---
  const cloudName = "du5blunb0"; 
  const uploadPreset = "mytube_preset";

  window.uploadVideo = async function() {
    const file = document.getElementById('videoFile').files[0];
    const title = document.getElementById('videoTitle').value;
    const status = document.getElementById('status');

    if (!file || !title) return alert("タイトルと動画を選んでね！");

    status.innerText = "アップロード中... (1080p対応モード)";

    // 大きな動画を分割して送る設定
    const chunkSize = 20 * 1024 * 1024; // 20MBずつ
    const totalChunks = Math.ceil(file.size / chunkSize);
    const uniqueUploadId = 'mytube_' + Date.now();
    let remoteURL = "";

    try {
      for (let i = 0; i < totalChunks; i++) {
        const start = i * chunkSize;
        const end = Math.min(file.size, start + chunkSize);
        const chunk = file.slice(start, end);

        const formData = new FormData();
        formData.append("file", chunk);
        formData.append("upload_preset", uploadPreset);
        const contentRange = `bytes ${start}-${end - 1}/${file.size}`;

        const response = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/video/upload`, {
          method: "POST",
          body: formData,
          headers: { "X-Unique-Upload-Id": uniqueUploadId, "Content-Range": contentRange }
        });

        const result = await response.json();
        const progress = Math.round(((i + 1) / totalChunks) * 100);
        status.innerText = `アップロード中: ${progress}%`;

        if (i === totalChunks - 1) remoteURL = result.secure_url;
      }

      if (remoteURL) {
        // ここでFirestore（台帳）にデータを追加！
        await addDoc(collection(db, "videos"), {
          title: title,
          url: remoteURL,
          createdAt: serverTimestamp()
        });
        status.innerText = "公開完了！Firebaseの台帳にも記録されました！";
      }
    } catch (error) {
      status.innerText = "エラー: " + error.message;
      console.error(error);
    }
  };
</script>

<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyTube - チャンネル</title>
    <style>
        :root { --primary-color: #ff0000; --bg-color: #f9f9f9; }
        body { font-family: sans-serif; background: var(--bg-color); margin: 0; padding: 0; }
        header { padding: 20px; display: flex; align-items: center; gap: 20px; background: white; border-bottom: 1px solid #ddd; }
        .channel-icon-large { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; }
        .channel-info h2 { margin: 0; font-size: 24px; }
        .sub-text { color: #606060; font-size: 14px; margin-top: 5px; }
        
        #videoList { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; padding: 20px; }
        .video-card { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); cursor: pointer; }
        video { width: 100%; aspect-ratio: 16/9; background: black; object-fit: cover; }
        .video-title { padding: 10px; font-weight: bold; font-size: 14px; }
    </style>
</head>
<body>

<header>
    <img src="" class="channel-icon-large" id="channelIcon">
    <div class="channel-info">
        <h2 id="channelName">読み込み中...</h2>
        <div id="subCount" class="sub-text">登録者 0人</div>
    </div>
    <button onclick="location.href='index.html'" style="margin-left:auto; padding:10px;">ホームへ</button>
</header>

<div id="videoList">動画を読み込み中...</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, getDoc, collection, query, where, getDocs, onSnapshot, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAZivYKOGc1tSUAIDq_c10C1wJ-Pdh0U2o",
        authDomain: "mytube-f4544.firebaseapp.com",
        projectId: "mytube-f4544",
        storageBucket: "mytube-f4544.firebasestorage.app",
        messagingSenderId: "655444283107",
        appId: "1:655444283107:web:04f9173faf2d951790ffd6"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const params = new URLSearchParams(window.location.search);
    const targetUid = params.get('uid');

    if (targetUid) {
        loadChannelInfo();
        loadChannelVideos();
    } else {
        alert("ユーザーIDが見つかりません");
        location.href = 'index.html';
    }

    // チャンネル情報の読み込み
    async function loadChannelInfo() {
        // ユーザー情報をリアルタイム監視 (onSnapshot)
        onSnapshot(doc(db, "users", targetUid), async (uDoc) => {
            if (uDoc.exists()) {
                const data = uDoc.data();
                document.getElementById('channelName').innerText = data.name || "名称未設定";
                document.getElementById('channelIcon').src = data.icon || "https://via.placeholder.com/80";

                // ★ここが完全版のポイント：管理者が書き換えた subCount があればそれを優先表示
                if (data.subCount !== undefined) {
                    document.getElementById('subCount').innerText = `登録者 ${Number(data.subCount).toLocaleString()}人`;
                } else {
                    // データがない場合は、実際の登録者ドキュメントを数える（初期用）
                    const subQuery = query(collection(db, "users", targetUid, "subscriptions")); 
                    const subSnapshot = await getDocs(subQuery);
                    document.getElementById('subCount').innerText = `登録者 ${subSnapshot.size.toLocaleString()}人`;
                }
            }
        });
    }

    // そのユーザーの動画一覧を読み込み
    function loadChannelVideos() {
        const q = query(collection(db, "videos"), where("userId", "==", targetUid), orderBy("createdAt", "desc"));
        onSnapshot(q, (snapshot) => {
            const list = document.getElementById('videoList');
            list.innerHTML = "";
            snapshot.forEach((vDoc) => {
                const data = vDoc.data();
                const card = document.createElement('div');
                card.className = 'video-card';
                card.onclick = () => location.href = `watch.html?id=${vDoc.id}`;
                card.innerHTML = `
                    <video src="${data.url}"></video>
                    <div class="video-title">${data.title}</div>
                `;
                list.appendChild(card);
            });
        });
    }
</script>
</body>
</html>

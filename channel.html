<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>チャンネル - MyTube</title>
    <style>
        body { font-family: sans-serif; margin: 0; background: #fff; text-align: center; }
        .header { padding: 40px 20px; border-bottom: 1px solid #eee; }
        .c-large-icon { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; background: #eee; }
        .v-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; padding: 20px; text-align: left; }
        .v-card { text-decoration: none; color: #000; }
        .thumb { width: 100%; aspect-ratio: 16/9; border-radius: 12px; background: #eee; object-fit: cover; opacity: 0; }
        .sub-btn { border: none; padding: 10px 24px; border-radius: 20px; font-weight: bold; cursor: pointer; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="header">
        <img id="chIcon" class="c-large-icon" src="">
        <h1 id="chName">読み込み中...</h1>
        <p id="chSubs">登録者 0人</p>
        <button id="subBtn" class="sub-btn">チャンネル登録</button>
    </div>
    <div class="v-grid" id="chVideos"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, updateDoc, increment, onSnapshot, setDoc, deleteDoc, collection, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAZivYKOGc1tSUAIDq_c10C1wJ-Pdh0U2o",
            authDomain: "mytube-f4544.firebaseapp.com",
            projectId: "mytube-f4544",
            storageBucket: "mytube-f4544.firebasestorage.app",
            messagingSenderId: "655444283107",
            appId: "1:655444283107:web:04f9173faf2d951790ffd6"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const chId = new URLSearchParams(window.location.search).get('id');
        let user = null;

        onAuthStateChanged(auth, u => { user = u; checkSubStatus(); });

        if(chId) {
            onSnapshot(doc(db, "users", chId), snap => {
                const d = snap.data();
                document.getElementById('chName').innerText = d.name;
                document.getElementById('chIcon').src = d.icon || "";
                document.getElementById('chSubs').innerText = `登録者 ${(d.subCount || 0).toLocaleString()}人`;
            });

            onSnapshot(query(collection(db, "videos"), where("userId", "==", chId)), snap => {
                const grid = document.getElementById('chVideos'); grid.innerHTML = "";
                snap.forEach(vDoc => {
                    const vd = vDoc.data(); const tid = `t-${vDoc.id}`;
                    grid.innerHTML += `<a href="watch.html?id=${vDoc.id}" class="v-card"><img src="" id="${tid}" class="thumb"><div>${vd.title}</div></a>`;
                    setTimeout(() => {
                        const img = document.getElementById(tid);
                        if(vd.thumbnail){ img.src = vd.thumbnail; img.style.opacity = 1; }
                        else { generateThumb(vd.url, img); }
                    }, 100);
                });
            });
        }

        document.getElementById('subBtn').onclick = async () => {
            if(!user) return alert("ログインしてください");
            if(user.uid === chId) return alert("自分は登録できません");
            const sRef = doc(db, "users", user.uid, "subscriptions", chId);
            const cRef = doc(db, "users", chId);
            const snap = await getDoc(sRef);
            if(snap.exists()){ await deleteDoc(sRef); await updateDoc(cRef, { subCount: increment(-1) }); }
            else { await setDoc(sRef, { a:1 }); await updateDoc(cRef, { subCount: increment(1) }); }
        };

        function checkSubStatus() {
            if(user && chId) {
                onSnapshot(doc(db, "users", user.uid, "subscriptions", chId), snap => {
                    const btn = document.getElementById('subBtn');
                    btn.innerText = snap.exists() ? "登録済み" : "チャンネル登録";
                    btn.style.background = snap.exists() ? "#f2f2f2" : "#000";
                    btn.style.color = snap.exists() ? "#000" : "#fff";
                });
            }
        }

        function generateThumb(url, imgElement) {
            const v = document.createElement('video'); v.src = url; v.preload = "auto"; v.muted = true; v.crossOrigin = "anonymous";
            v.onloadeddata = () => v.currentTime = 1.0;
            v.onseeked = () => { const c = document.createElement('canvas'); c.width = 320; c.height = 180; c.getContext('2d').drawImage(v, 0, 0, 320, 180); imgElement.src = c.toDataURL('image/jpeg'); imgElement.style.opacity = 1; };
        }
    </script>
</body>
</html>

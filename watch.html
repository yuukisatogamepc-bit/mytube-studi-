<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å†ç”Ÿ - Mvideo</title>
    <style>
        body { font-family: sans-serif; margin: 0; background: #fff; display: flex; flex-direction: column; align-items: center; }
        header { width: 100%; padding: 10px 20px; border-bottom: 1px solid #eee; box-sizing: border-box; }
        .logo { font-size: 22px; font-weight: bold; text-decoration: none; color: #ff0000; }
        .container { display: flex; max-width: 1200px; width: 100%; gap: 20px; padding: 20px; box-sizing: border-box; }
        .main-col { flex: 2; }
        .side-col { flex: 1; }
        video { width: 100%; aspect-ratio: 16/9; background: #000; border-radius: 12px; }
        .v-title { font-size: 20px; font-weight: bold; margin: 15px 0; }
        .action-bar { display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .author-info { display: flex; align-items: center; gap: 10px; }
        .author-icon { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; background: #eee; }
        .btn { padding: 8px 16px; border-radius: 20px; border: none; cursor: pointer; font-weight: bold; }
        .btn-like { background: #eee; }
        .btn-like.active { background: #ff0000; color: #fff; }
        .btn-sub { background: #ff0000; color: #fff; }
        .btn-sub.active { background: #eee; color: #606060; }
        .admin-del { background: #ff4d4d; color: #fff; display: none; margin-left: 10px; }
        .edit-num { cursor: pointer; text-decoration: underline dotted; }
        .stat-val { font-weight: bold; }

        .comment-section { margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px; }
        .comment-input { width: 100%; padding: 10px; border: none; border-bottom: 1px solid #ddd; margin-bottom: 10px; outline: none; }
        .comment-item { margin-bottom: 20px; font-size: 14px; }
        .comment-main { display: flex; gap: 10px; }
        .reply-list { margin-left: 50px; margin-top: 10px; border-left: 2px solid #eee; padding-left: 10px; }
        .reply-btn { font-size: 12px; color: #606060; cursor: pointer; background: none; border: none; padding: 5px; margin-top: 5px; }
        .reply-input-area { margin-left: 50px; display: none; margin-top: 5px; }
        
        /* ãƒãƒƒã‚¸ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .admin-badge { color: #ff0000; font-weight: bold; margin-left: 4px; }
        .official-badge { color: #007bff; font-weight: bold; margin-left: 4px; }
    </style>
</head>
<body>

<header><a href="index.html" class="logo">Mvideo</a></header>

<div class="container">
    <div class="main-col">
        <video id="player" controls autoplay></video>
        <div id="vTitle" class="v-title">èª­ã¿è¾¼ã¿ä¸­...</div>
        <div style="font-size:14px; color:#606060; margin-bottom:10px;">
            å†ç”Ÿå›æ•° <span id="viewNum" class="stat-val">0</span>å›
        </div>
        <div class="action-bar">
            <div class="author-info">
                <img id="authorIcon" class="author-icon">
                <div>
                    <div id="authorName" style="font-weight:bold;">èª­ã¿è¾¼ã¿ä¸­...</div>
                    <div style="font-size:12px; color:#606060;">ç™»éŒ²è€… <span id="subNum" class="stat-val">0</span>äºº</div>
                </div>
                <button class="btn btn-sub" id="subBtn">ãƒãƒ£ãƒ³ãƒãƒ«ç™»éŒ²</button>
            </div>
            <div class="btn-group">
                <button class="btn btn-like" id="likeBtn">ğŸ‘ <span id="likeNum" class="stat-val">0</span></button>
                <button id="adminDelBtn" class="btn admin-del">å‰Šé™¤</button>
            </div>
        </div>

        <div class="comment-section">
            <h3 id="commentHeader">ã‚³ãƒ¡ãƒ³ãƒˆ 0ä»¶</h3>
            <input type="text" id="commentInput" class="comment-input" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ...">
            <div id="commentList"></div>
        </div>
    </div>
    <div class="side-col" id="relatedList"></div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, getDoc, collection, query, updateDoc, increment, addDoc, serverTimestamp, onSnapshot, deleteDoc, setDoc, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAZivYKOGc1tSUAIDq_c10C1wJ-Pdh0U2o",
        authDomain: "mytube-f4544.firebaseapp.com",
        projectId: "mytube-f4544",
        storageBucket: "mytube-f4544.firebasestorage.app",
        messagingSenderId: "655444283107",
        appId: "1:655444283107:web:04f9173faf2d951790ffd6"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const vid = new URLSearchParams(window.location.search).get("id");
    const ADMIN_UID = "tP5CqCTRO3f2QQ8jdoj0ftY8kZU2";
    const OFFICIAL_UID = "UUgBXquGY5O2iDADKpwNUU0i5Ct2"; // æŒ‡å®šã•ã‚ŒãŸUID
    let currentUser = null;

    onAuthStateChanged(auth, user => {
        currentUser = user;
        if(user && vid) {
            if(user.uid === ADMIN_UID) setupAdmin();
            checkStates();
        }
    });

    if (vid) load();

    // ãƒãƒƒã‚¸ç”Ÿæˆé–¢æ•°
    function getBadgeHTML(userId) {
        if (userId === ADMIN_UID) return '<span class="admin-badge">[é‹å–¶]</span>';
        if (userId === OFFICIAL_UID) return '<span class="official-badge">[å…¬å¼]</span>';
        return '';
    }

    async function load() {
        const vRef = doc(db, "videos", vid);
        const vSnap = await getDoc(vRef);
        const v = vSnap.data();
        document.getElementById('player').src = v.url;
        document.getElementById('vTitle').innerText = v.title;
        document.getElementById('viewNum').innerText = v.views || 0;
        document.getElementById('likeNum').innerText = v.likes || 0;

        const uSnap = await getDoc(doc(db, "users", v.userId));
        if(uSnap.exists()) {
            const userData = uSnap.data();
            // å‹•ç”»æŠ•ç¨¿è€…ã®åå‰ã®æ¨ªã«ã‚‚ãƒãƒƒã‚¸ã‚’åæ˜ 
            document.getElementById('authorName').innerHTML = userData.name + getBadgeHTML(v.userId);
            document.getElementById('authorIcon').src = userData.icon || "";
            document.getElementById('subNum').innerText = userData.subscribers || 0;
        }

        document.getElementById('likeBtn').onclick = async () => {
            if(!currentUser) return alert("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã­");
            const btn = document.getElementById('likeBtn');
            const ref = doc(db, "videos", vid, "likedUsers", currentUser.uid);
            const isLiked = btn.classList.contains('active');
            await (isLiked ? deleteDoc(ref) : setDoc(ref, {u:1}));
            await updateDoc(vRef, { likes: increment(isLiked ? -1 : 1) });
            btn.classList.toggle('active');
            const fresh = await getDoc(vRef);
            document.getElementById('likeNum').innerText = fresh.data().likes;
        };

        document.getElementById('subBtn').onclick = async () => {
            if(!currentUser) return alert("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã­");
            const btn = document.getElementById('subBtn');
            const uRef = doc(db, "users", v.userId);
            const ref = doc(uRef, "subscriberList", currentUser.uid);
            const isSub = btn.classList.contains('active');
            await (isSub ? deleteDoc(ref) : setDoc(ref, {u:1}));
            await updateDoc(uRef, { subscribers: increment(isSub ? -1 : 1) });
            btn.classList.toggle('active');
            btn.innerText = isSub ? "ãƒãƒ£ãƒ³ãƒãƒ«ç™»éŒ²" : "ç™»éŒ²æ¸ˆã¿";
            const fresh = await getDoc(uRef);
            document.getElementById('subNum').innerText = fresh.data().subscribers;
        };

        const cCol = collection(db, "videos", vid, "comments");
        onSnapshot(query(cCol, orderBy("createdAt", "desc")), snap => {
            document.getElementById('commentHeader').innerText = `ã‚³ãƒ¡ãƒ³ãƒˆ ${snap.size}ä»¶`;
            const list = document.getElementById('commentList');
            list.innerHTML = "";
            snap.forEach(d => {
                const c = d.data();
                const cid = d.id;
                const badge = getBadgeHTML(c.userId);
                
                const div = document.createElement('div');
                div.className = "comment-item";
                div.innerHTML = `
                    <div class="comment-main">
                        <strong>${c.userName || 'åŒ¿å'}${badge}</strong>: ${c.text}
                    </div>
                    <button class="reply-btn" onclick="toggleReply('${cid}')">è¿”ä¿¡</button>
                    <div id="reply-area-${cid}" class="reply-input-area">
                        <input type="text" id="input-${cid}" class="comment-input" placeholder="è¿”ä¿¡ã‚’æ›¸ã...">
                    </div>
                    <div id="replies-${cid}" class="reply-list"></div>
                `;
                list.appendChild(div);

                onSnapshot(query(collection(db, "videos", vid, "comments", cid, "replies"), orderBy("createdAt", "asc")), rSnap => {
                    const rList = document.getElementById(`replies-${cid}`);
                    rList.innerHTML = "";
                    rSnap.forEach(rd => {
                        const r = rd.data();
                        const rBadge = getBadgeHTML(r.userId);
                        rList.innerHTML += `<div><strong>${r.userName}${rBadge}</strong>: ${r.text}</div>`;
                    });
                });

                document.getElementById(`input-${cid}`).onkeypress = async (e) => {
                    if (e.key === 'Enter' && currentUser && e.target.value.trim()) {
                        const mySnap = await getDoc(doc(db, "users", currentUser.uid));
                        await addDoc(collection(db, "videos", vid, "comments", cid, "replies"), {
                            text: e.target.value,
                            userName: mySnap.data()?.name || "åŒ¿å",
                            userId: currentUser.uid,
                            createdAt: serverTimestamp()
                        });
                        e.target.value = "";
                        toggleReply(cid);
                    }
                };
            });
        });

        document.getElementById('commentInput').onkeypress = async (e) => {
            if (e.key === 'Enter' && currentUser && e.target.value.trim()) {
                const mySnap = await getDoc(doc(db, "users", currentUser.uid));
                await addDoc(cCol, {
                    text: e.target.value,
                    userName: mySnap.data()?.name || "åŒ¿å",
                    userId: currentUser.uid,
                    createdAt: serverTimestamp()
                });
                e.target.value = "";
            }
        };

        updateDoc(vRef, { views: increment(1) });
    }

    window.toggleReply = (cid) => {
        const area = document.getElementById(`reply-area-${cid}`);
        area.style.display = area.style.display === "block" ? "none" : "block";
    };

    async function checkStates() {
        const l = await getDoc(doc(db, "videos", vid, "likedUsers", currentUser.uid));
        if(l.exists()) document.getElementById('likeBtn').classList.add('active');
        const v = await getDoc(doc(db, "videos", vid));
        const s = await getDoc(doc(db, "users", v.data().userId, "subscriberList", currentUser.uid));
        if(s.exists()) {
            document.getElementById('subBtn').classList.add('active');
            document.getElementById('subBtn').innerText = "ç™»éŒ²æ¸ˆã¿";
        }
    }

    function setupAdmin() {
        document.getElementById('adminDelBtn').style.display = "inline-block";
        document.querySelectorAll('.stat-val').forEach(el => {
            el.classList.add('edit-num');
            el.onclick = async (e) => {
                e.stopPropagation();
                const val = prompt("æ•°å€¤å¤‰æ›´:", el.innerText);
                if(val !== null) {
                    let ref = doc(db, "videos", vid);
                    let key = el.id === "viewNum" ? "views" : "likes";
                    if(el.id === "subNum") {
                        const v = await getDoc(doc(db, "videos", vid));
                        ref = doc(db, "users", v.data().userId);
                        key = "subscribers";
                    }
                    await updateDoc(ref, { [key]: parseInt(val) });
                    el.innerText = val;
                }
            };
        });
        document.getElementById('adminDelBtn').onclick = async () => {
            if(confirm("æ¶ˆã™ï¼Ÿ")) { await deleteDoc(doc(db, "videos", vid)); location.href="index.html"; }
        };
    }
</script>
</body>
</html>

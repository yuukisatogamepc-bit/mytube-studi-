<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å†ç”Ÿ - iroTube</title>
    <style>
        body { font-family: sans-serif; margin: 0; background: #fff; display: flex; flex-direction: column; align-items: center; }
        header { width: 100%; padding: 10px 20px; border-bottom: 1px solid #eee; box-sizing: border-box; }
        .logo { font-size: 20px; font-weight: bold; text-decoration: none; color: #007bff; }
        
        .container { display: flex; max-width: 1200px; width: 100%; gap: 20px; padding: 20px; box-sizing: border-box; }
        .main-col { flex: 2; }
        .side-col { flex: 1; }

        video { width: 100%; aspect-ratio: 16/9; background: #000; border-radius: 12px; }
        .v-title { font-size: 20px; font-weight: bold; margin: 15px 0; }
        
        .action-bar { display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .author-info { display: flex; align-items: center; gap: 10px; }
        .author-icon { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        .author-name { font-weight: bold; text-decoration: none; color: #000; }
        
        .btn-group { display: flex; gap: 10px; }
        .btn { padding: 8px 16px; border-radius: 20px; border: none; cursor: pointer; font-weight: bold; }
        .btn-like { background: #eee; }
        .btn-sub { background: #000; color: #fff; }

        /* ã‚³ãƒ¡ãƒ³ãƒˆæ¬„ */
        .comment-section { margin-top: 20px; }
        .comment-input { width: 100%; padding: 10px; border: none; border-bottom: 1px solid #ddd; margin-bottom: 10px; outline: none; }
        .comment-item { display: flex; gap: 10px; margin-bottom: 15px; font-size: 14px; }
        .comment-text { line-height: 1.4; }

        /* é–¢é€£å‹•ç”» */
        .side-card { display: flex; gap: 10px; text-decoration: none; color: #000; margin-bottom: 12px; }
        .side-thumb { width: 120px; aspect-ratio: 16/9; background: #eee; border-radius: 8px; object-fit: cover; }
        .side-title { font-size: 13px; font-weight: bold; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }
    </style>
</head>
<body>

<header><a href="index.html" class="logo">iroTube</a></header>

<div class="container">
    <div class="main-col">
        <video id="player" controls autoplay></video>
        <div id="vTitle" class="v-title">èª­ã¿è¾¼ã¿ä¸­...</div>
        
        <div class="action-bar">
            <div class="author-info">
                <a id="authorLink" href=""><img id="authorIcon" class="author-icon" src=""></a>
                <div>
                    <a id="authorName" href="" class="author-name">èª­ã¿è¾¼ã¿ä¸­...</a>
                    <div id="subCount" style="font-size:12px; color:#606060;">ç™»éŒ²è€… 0äºº</div>
                </div>
                <button class="btn btn-sub" id="subBtn">ãƒãƒ£ãƒ³ãƒãƒ«ç™»éŒ²</button>
            </div>
            <div class="btn-group">
                <button class="btn btn-like" id="likeBtn">ğŸ‘ <span id="likeCount">0</span></button>
            </div>
        </div>

        <div class="comment-section">
            <h3 id="commentHeader">ã‚³ãƒ¡ãƒ³ãƒˆ 0ä»¶</h3>
            <input type="text" id="commentInput" class="comment-input" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ...">
            <div id="commentList"></div>
        </div>
    </div>

    <div class="side-col">
        <h4>é–¢é€£å‹•ç”»</h4>
        <div id="relatedList"></div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, getDoc, getDocs, collection, query, limit, updateDoc, increment, addDoc, serverTimestamp, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAZivYKOGc1tSUAIDq_c10C1wJ-Pdh0U2o",
        authDomain: "mytube-f4544.firebaseapp.com",
        projectId: "mytube-f4544",
        storageBucket: "mytube-f4544.firebasestorage.app",
        messagingSenderId: "655444283107",
        appId: "1:655444283107:web:04f9173faf2d951790ffd6"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const params = new URLSearchParams(window.location.search);
    const vid = params.get("id");
    let currentUser = null;

    onAuthStateChanged(auth, user => { currentUser = user; });

    if (vid) { loadWatchPage(); }

    async function loadWatchPage() {
        const vSnap = await getDoc(doc(db, "videos", vid));
        if (!vSnap.exists()) return;
        const v = vSnap.data();
        
        // 1. å‹•ç”»å†ç”Ÿã¨ã‚¿ã‚¤ãƒˆãƒ«
        document.getElementById('player').src = v.url;
        document.getElementById('vTitle').innerText = v.title;
        document.getElementById('likeCount').innerText = v.likes || 0;

        // 2. æŠ•ç¨¿è€…æƒ…å ±ã®å–å¾— (é·ç§»å…ˆã®ä¿®æ­£)
        const uSnap = await getDoc(doc(db, "users", v.userId));
        if (uSnap.exists()) {
            const ud = uSnap.data();
            const channelUrl = `channel.html?id=${v.userId}`; // ã“ã“ã‚’æŠ•ç¨¿è€…IDã«å›ºå®š
            document.getElementById('authorLink').href = channelUrl;
            document.getElementById('authorName').href = channelUrl;
            document.getElementById('authorName').innerText = ud.name;
            document.getElementById('authorIcon').src = ud.icon || "";
        }

        // 3. é«˜è©•ä¾¡æ©Ÿèƒ½
        document.getElementById('likeBtn').onclick = async () => {
            if (!currentUser) return alert("ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™");
            await updateDoc(doc(db, "videos", vid), { likes: increment(1) });
            document.getElementById('likeCount').innerText = parseInt(document.getElementById('likeCount').innerText) + 1;
        };

        // 4. ã‚³ãƒ¡ãƒ³ãƒˆæ©Ÿèƒ½
        const cCol = collection(db, "videos", vid, "comments");
        onSnapshot(cCol, snap => {
            document.getElementById('commentHeader').innerText = `ã‚³ãƒ¡ãƒ³ãƒˆ ${snap.size}ä»¶`;
            document.getElementById('commentList').innerHTML = "";
            snap.forEach(doc => {
                const c = doc.data();
                document.getElementById('commentList').innerHTML += `
                    <div class="comment-item">
                        <div class="comment-text"><strong>${c.userName}</strong><br>${c.text}</div>
                    </div>`;
            });
        });

        document.getElementById('commentInput').onkeypress = async (e) => {
            if (e.key === 'Enter' && currentUser) {
                const uSnap = await getDoc(doc(db, "users", currentUser.uid));
                await addDoc(cCol, {
                    text: e.target.value,
                    userName: uSnap.data().name,
                    userId: currentUser.uid,
                    createdAt: serverTimestamp()
                });
                e.target.value = "";
            }
        };

        // 5. é–¢é€£å‹•ç”» (å…¨å‹•ç”»ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«å–å¾—)
        const vCols = await getDocs(query(collection(db, "videos"), limit(10)));
        vCols.forEach(doc => {
            if (doc.id !== vid) {
                const rv = doc.data();
                document.getElementById('relatedList').innerHTML += `
                    <a href="watch.html?id=${doc.id}" class="side-card">
                        <img class="side-thumb" src="${rv.thumbnail || ''}">
                        <div class="side-title">${rv.title}</div>
                    </a>`;
            }
        });

        // è¦–è´å›æ•°ã‚¢ãƒƒãƒ—
        updateDoc(doc(db, "videos", vid), { views: increment(1) });
    }
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyTube - å†ç”Ÿ (Admin)</title>
    <style>
        body { font-family: sans-serif; margin: 0; background: #f9f9f9; padding: 20px; }
        .main-container { max-width: 900px; margin: 0 auto; }
        video { width: 100%; background: #000; border-radius: 12px; aspect-ratio: 16/9; }
        
        /* ç®¡ç†è€…ãƒ‘ãƒãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #adminEditPanel { display: none; background: #222; color: #fff; padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 2px solid gold; }
        #adminEditPanel input { width: 80px; padding: 5px; margin: 5px; border-radius: 4px; border: none; }
        .admin-btn { background: gold; color: black; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; }

        .video-info { margin-top: 15px; }
        .stats-row { color: #606060; font-size: 14px; margin: 8px 0; }
        
        .channel-info { display: flex; align-items: center; gap: 12px; padding: 15px 0; border-bottom: 1px solid #ddd; border-top: 1px solid #ddd; margin-top: 15px; }
        .channel-icon { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; }
        .channel-details { flex-grow: 1; }
        .author-name { font-weight: bold; display: block; }
        .sub-btn { background: #0f0f0f; color: white; border-radius: 20px; padding: 8px 18px; border: none; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

<div class="main-container">
    <div id="adminEditPanel">
        <h3 style="color:gold; margin-top:0;">ğŸ‘‘ ç®¡ç†è€…ç”¨ æ•°å€¤ç·¨é›†</h3>
        <div>
            å†ç”Ÿå›æ•°: <input type="number" id="editViews">
            é«˜è©•ä¾¡æ•°: <input type="number" id="editLikes">
            ç™»éŒ²è€…æ•°: <input type="number" id="editSubs">
            <button class="admin-btn" onclick="updateVideoStats()">æ•°å€¤ã‚’ä¿å­˜ã™ã‚‹</button>
        </div>
        <div id="myUidDisplay" style="font-size: 11px; margin-top: 10px; color: #aaa;"></div>
    </div>

    <video id="player" controls></video>
    <div class="video-info">
        <h2 id="videoTitle" style="margin:10px 0;">èª­ã¿è¾¼ã¿ä¸­...</h2>
        <div class="stats-row">
            å†ç”Ÿå›æ•° <span id="viewCountDisplay">0</span>å› ãƒ» 
            é«˜è©•ä¾¡ <span id="likeCountDisplay">0</span>
        </div>
    </div>

    <div class="channel-info">
        <img src="" class="channel-icon" id="authorIcon">
        <div class="channel-details">
            <span class="author-name" id="authorName">èª­ã¿è¾¼ã¿ä¸­...</span>
            <span id="subCountDisplay" style="font-size:12px; color:#606060;">ç™»éŒ²è€… 0äºº</span>
        </div>
        <button class="sub-btn" id="subscribeBtn">ãƒãƒ£ãƒ³ãƒãƒ«ç™»éŒ²</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, getDoc, updateDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAZivYKOGc1tSUAIDq_c10C1wJ-Pdh0U2o",
        authDomain: "mytube-f4544.firebaseapp.com",
        projectId: "mytube-f4544",
        storageBucket: "mytube-f4544.firebasestorage.app",
        messagingSenderId: "655444283107",
        appId: "1:655444283107:web:04f9173faf2d951790ffd6"
    };

    // â˜…åˆ¤æ˜ã—ãŸã‚ãªãŸã®UIDã‚’ã“ã“ã«è²¼ã£ã¦ãã ã•ã„â˜…
    const ADMIN_UID = "tP5CqCTRO3f2QQ8jdoj0ftY8kZU2"; 

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const params = new URLSearchParams(window.location.search);
    const videoId = params.get('id');
    let currentUser = null;
    let isAdminMode = false;
    let targetAuthorId = "";

    // éš ã—ã‚³ãƒãƒ³ãƒ‰åˆ¤å®š (abbmytube)
    let inputBuffer = "";
    window.addEventListener('keydown', (e) => {
        inputBuffer += e.key.toLowerCase();
        if (inputBuffer.length > 9) inputBuffer = inputBuffer.substring(1);
        if (inputBuffer === "abbmytube") {
            isAdminMode = !isAdminMode;
            document.getElementById('adminEditPanel').style.display = isAdminMode ? 'block' : 'none';
            if(currentUser) document.getElementById('myUidDisplay').innerText = "tP5CqCTRO3f2QQ8jdoj0ftY8kZU2: " + currentUser.uid;
            alert("ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰: " + (isAdminMode ? "ON" : "OFF"));
        }
    });

    onAuthStateChanged(auth, (user) => {
        currentUser = user;
        loadVideo();
    });

    async function loadVideo() {
        if (!videoId) return;
        
        onSnapshot(doc(db, "videos", videoId), async (vDoc) => {
            if (!vDoc.exists()) return;
            const data = vDoc.data();
            targetAuthorId = data.userId;
            
            document.getElementById('player').src = data.url;
            document.getElementById('videoTitle').innerText = data.title;
            document.getElementById('viewCountDisplay').innerText = data.views || 0;
            document.getElementById('likeCountDisplay').innerText = data.likes || 0;

            // ç®¡ç†è€…ç”¨å…¥åŠ›æ¬„ã«ç¾åœ¨ã®å€¤ã‚’ã‚»ãƒƒãƒˆ
            document.getElementById('editViews').value = data.views || 0;
            document.getElementById('editLikes').value = data.likes || 0;

            // æŠ•ç¨¿è€…ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«
            const userDoc = await getDoc(doc(db, "users", data.userId));
            if (userDoc.exists()) {
                const uData = userDoc.data();
                document.getElementById('authorName').innerText = uData.name;
                document.getElementById('authorIcon').src = uData.icon;
                document.getElementById('subCountDisplay').innerText = `ç™»éŒ²è€… ${uData.subCount || 0}äºº`;
                document.getElementById('editSubs').value = uData.subCount || 0;
            }
        });
    }

    // ç®¡ç†è€…ã«ã‚ˆã‚‹æ•°å€¤æ›´æ–°
    window.updateVideoStats = async () => {
        if (!currentUser || currentUser.uid !== ADMIN_UID) {
            alert("æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“");
            return;
        }

        const newViews = parseInt(document.getElementById('editViews').value);
        const newLikes = parseInt(document.getElementById('editLikes').value);
        const newSubs = parseInt(document.getElementById('editSubs').value);

        // å‹•ç”»ã®å†ç”Ÿæ•°ãƒ»ã„ã„ã­æ•°ã‚’æ›´æ–°
        await updateDoc(doc(db, "videos", videoId), {
            views: newViews,
            likes: newLikes
        });

        // æŠ•ç¨¿è€…ã®ç™»éŒ²è€…æ•°ã‚’æ›´æ–°
        if (targetAuthorId) {
            await updateDoc(doc(db, "users", targetAuthorId), {
                subCount: newSubs
            });
        }

        alert("æ•°å€¤ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼");
    };
</script>
</body>
</html>

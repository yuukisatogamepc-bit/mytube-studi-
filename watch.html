<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>再生 - iroTube</title>
    <style>
        body { font-family: sans-serif; margin: 0; background: #fff; }
        header { padding: 10px 20px; border-bottom: 1px solid #eee; }
        .logo { font-size: 20px; font-weight: bold; text-decoration: none; color: #007bff; }
        
        .main-content { max-width: 1200px; margin: 20px auto; padding: 0 20px; }
        video { width: 100%; aspect-ratio: 16/9; background: #000; border-radius: 12px; }
        
        .v-info { margin-top: 15px; }
        .v-title { font-size: 20px; font-weight: bold; margin-bottom: 10px; }
        
        /* 投稿者エリアのデザイン */
        .author-area { display: flex; align-items: center; gap: 12px; margin-top: 15px; padding: 10px 0; border-top: 1px solid #eee; }
        .author-icon { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; background: #eee; cursor: pointer; }
        .author-name { font-weight: bold; text-decoration: none; color: #000; font-size: 16px; }
        .author-name:hover { text-decoration: underline; }
        
        .v-stats { color: #606060; font-size: 14px; margin-top: 8px; }
    </style>
</head>
<body>

<header>
    <a href="index.html" class="logo">iroTube</a>
</header>

<div class="main-content">
    <video id="player" controls autoplay></video>
    
    <div class="v-info">
        <div id="vTitle" class="v-title">読み込み中...</div>
        <div id="vStats" class="v-stats">視聴回数 0回</div>
        
        <div class="author-area">
            <a id="authorLink1" href="#"><img src="" id="authorIcon" class="author-icon"></a>
            <a id="authorLink2" href="#" class="author-name">読み込み中...</a>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, getDoc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAZivYKOGc1tSUAIDq_c10C1wJ-Pdh0U2o",
        authDomain: "mytube-f4544.firebaseapp.com",
        projectId: "mytube-f4544",
        storageBucket: "mytube-f4544.firebasestorage.app",
        messagingSenderId: "655444283107",
        appId: "1:655444283107:web:04f9173faf2d951790ffd6"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // URLから動画IDを取得
    const params = new URLSearchParams(window.location.search);
    const vid = params.get("id");

    if (vid) {
        loadVideo();
    } else {
        location.href = "index.html";
    }

    async function loadVideo() {
        const vSnap = await getDoc(doc(db, "videos", vid));
        if (vSnap.exists()) {
            const v = vSnap.data();
            
            // 動画再生・タイトル設定
            document.getElementById('player').src = v.url;
            document.getElementById('vTitle').innerText = v.title;
            document.getElementById('vStats').innerText = `${(v.views || 0).toLocaleString()}回視聴`;

            // 投稿者（作者）の情報を取得
            const uSnap = await getDoc(doc(db, "users", v.userId));
            if (uSnap.exists()) {
                const ud = uSnap.data();
                const authorId = v.userId; // これが投稿者のID

                // リンク先を「投稿者のID」に修正
                const channelUrl = `channel.html?id=${authorId}`;
                document.getElementById('authorLink1').href = channelUrl;
                document.getElementById('authorLink2').href = channelUrl;
                
                document.getElementById('authorIcon').src = ud.icon || "";
                document.getElementById('authorLink2').innerText = ud.name || "名称未設定";
            }

            // 視聴回数を＋1（簡易カウント）
            updateDoc(doc(db, "videos", vid), {
                views: increment(1)
            });
        } else {
            alert("動画が見つかりません");
            location.href = "index.html";
        }
    }
</script>
</body>
</html>

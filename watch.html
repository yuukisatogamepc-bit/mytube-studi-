<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å†ç”Ÿ - iroTube</title>
    <style>
        body { font-family: sans-serif; margin: 0; background: #fff; display: flex; flex-direction: column; align-items: center; }
        header { width: 100%; padding: 10px 20px; border-bottom: 1px solid #eee; box-sizing: border-box; }
        .logo { font-size: 20px; font-weight: bold; text-decoration: none; color: #007bff; }
        .container { display: flex; max-width: 1200px; width: 100%; gap: 20px; padding: 20px; box-sizing: border-box; }
        .main-col { flex: 2; }
        .side-col { flex: 1; }
        video { width: 100%; aspect-ratio: 16/9; background: #000; border-radius: 12px; }
        .v-title { font-size: 20px; font-weight: bold; margin: 15px 0; }
        .action-bar { display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .author-info { display: flex; align-items: center; gap: 10px; }
        .author-icon { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; background: #eee; }
        .author-name { font-weight: bold; text-decoration: none; color: #000; }
        .btn-group { display: flex; gap: 10px; align-items: center; }
        .btn { padding: 8px 16px; border-radius: 20px; border: none; cursor: pointer; font-weight: bold; transition: 0.2s; }
        
        .btn-like { background: #eee; }
        .btn-like.active { background: #007bff; color: #fff; }
        .btn-sub { background: #cc0000; color: #fff; }
        .btn-sub.active { background: #eee; color: #606060; }
        
        .admin-del-btn { background: #ff4d4d; color: #fff; font-size: 12px; display: none; padding: 8px 12px; border-radius: 5px; border: none; cursor: pointer; }
        .admin-editable { cursor: pointer; border-bottom: 1px dashed #ccc; }
        .admin-editable:hover { background: #fffde7; }

        .comment-section { margin-top: 20px; }
        .comment-input { width: 100%; padding: 10px; border: none; border-bottom: 1px solid #ddd; margin-bottom: 10px; outline: none; }
        .comment-item { display: flex; gap: 10px; margin-bottom: 15px; font-size: 14px; }
        .side-card { display: flex; gap: 10px; text-decoration: none; color: #000; margin-bottom: 12px; }
        .side-thumb { width: 120px; aspect-ratio: 16/9; background: #eee; border-radius: 8px; object-fit: cover; }
    </style>
</head>
<body>

<header><a href="index.html" class="logo">iroTube</a></header>

<div class="container">
    <div class="main-col">
        <video id="player" controls autoplay></video>
        <div id="vTitle" class="v-title">èª­ã¿è¾¼ã¿ä¸­...</div>
        <div id="vStats" style="font-size:14px; color:#606060; margin-bottom:10px;">
            å†ç”Ÿå›æ•° <span id="viewCountDisplay">0</span>å›
        </div>
        <div class="action-bar">
            <div class="author-info">
                <a id="authorLink" href=""><img id="authorIcon" class="author-icon"></a>
                <div>
                    <a id="authorName" href="" class="author-name">èª­ã¿è¾¼ã¿ä¸­...</a>
                    <div id="subCountArea" style="font-size:12px; color:#606060;">ç™»éŒ²è€… <span id="subCountDisplay">0</span>äºº</div>
                </div>
                <button class="btn btn-sub" id="subBtn">ãƒãƒ£ãƒ³ãƒãƒ«ç™»éŒ²</button>
            </div>
            <div class="btn-group">
                <button class="btn btn-like" id="likeBtn">ğŸ‘ <span id="likeCount">0</span></button>
                <button id="adminDelBtn" class="admin-del-btn">å‹•ç”»ã‚’å‰Šé™¤</button>
            </div>
        </div>
        <div class="comment-section">
            <h3 id="commentHeader">ã‚³ãƒ¡ãƒ³ãƒˆ 0ä»¶</h3>
            <input type="text" id="commentInput" class="comment-input" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ...">
            <div id="commentList"></div>
        </div>
    </div>
    <div class="side-col">
        <h4>é–¢é€£å‹•ç”»</h4>
        <div id="relatedList"></div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, getDoc, getDocs, collection, query, limit, updateDoc, increment, addDoc, serverTimestamp, onSnapshot, deleteDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAZivYKOGc1tSUAIDq_c10C1wJ-Pdh0U2o",
        authDomain: "mytube-f4544.firebaseapp.com",
        projectId: "mytube-f4544",
        storageBucket: "mytube-f4544.firebasestorage.app",
        messagingSenderId: "655444283107",
        appId: "1:655444283107:web:04f9173faf2d951790ffd6"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const params = new URLSearchParams(window.location.search);
    const vid = params.get("id");
    let currentUser = null;

    const ADMIN_UID = "tP5CqCTRO3f2QQ8jdoj0ftY8kZU2"; 

    onAuthStateChanged(auth, user => { 
        currentUser = user; 
        if(user && user.uid === ADMIN_UID) {
            document.getElementById('adminDelBtn').style.display = 'block';
            setupAdminEditing();
        }
        if(vid && user) checkUserStates();
    });

    if (vid) { loadWatchPage(); }

    function setupAdminEditing() {
        const editFields = [
            { id: 'viewCountDisplay', key: 'views', refPath: () => doc(db, "videos", vid) },
            { id: 'likeCount', key: 'likes', refPath: () => doc(db, "videos", vid) },
            { id: 'subCountDisplay', key: 'subscribers', refPath: async () => {
                const vSnap = await getDoc(doc(db, "videos", vid));
                return doc(db, "users", vSnap.data().userId);
            }}
        ];

        editFields.forEach(field => {
            const el = document.getElementById(field.id);
            if(!el) return;
            el.classList.add('admin-editable');
            el.onclick = async (e) => {
                e.stopPropagation(); // é‡è¤‡å‹•ä½œé˜²æ­¢
                const newVal = prompt("æ•°å€¤ã‚’å¤‰æ›´:", el.innerText.replace(/,/g, ''));
                if (newVal !== null && !isNaN(newVal)) {
                    const targetRef = typeof field.refPath === 'function' && field.refPath.constructor.name === 'AsyncFunction' 
                                      ? await field.refPath() : field.refPath();
                    await updateDoc(targetRef, { [field.key]: parseInt(newVal) });
                    el.innerText = parseInt(newVal).toLocaleString();
                }
            };
        });
    }

    async function checkUserStates() {
        if(!currentUser) return;
        const likeSnap = await getDoc(doc(db, "videos", vid, "likedUsers", currentUser.uid));
        if(likeSnap.exists()) document.getElementById('likeBtn').classList.add('active');

        const vSnap = await getDoc(doc(db, "videos", vid));
        if(vSnap.exists()){
            const authorId = vSnap.data().userId;
            const subSnap = await getDoc(doc(db, "users", authorId, "subscriberList", currentUser.uid));
            if(subSnap.exists()) {
                const sBtn = document.getElementById('subBtn');
                sBtn.innerText = "ç™»éŒ²æ¸ˆã¿";
                sBtn.classList.add('active');
            }
        }
    }

    async function loadWatchPage() {
        const vRef = doc(db, "videos", vid);
        const vSnap = await getDoc(vRef);
        if (!vSnap.exists()) return;
        const v = vSnap.data();
        
        document.getElementById('player').src = v.url;
        document.getElementById('vTitle').innerText = v.title;
        document.getElementById('viewCountDisplay').innerText = (v.views || 0).toLocaleString();
        document.getElementById('likeCount').innerText = v.likes || 0;

        document.getElementById('adminDelBtn').onclick = async () => {
            if (confirm("ç®¡ç†è€…ã¨ã—ã¦å‹•ç”»ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
                await deleteDoc(vRef);
                location.href = "index.html";
            }
        };

        const uRef = doc(db, "users", v.userId);
        const uSnap = await getDoc(uRef);
        if (uSnap.exists()) {
            const ud = uSnap.data();
            const channelUrl = `channel.html?id=${v.userId}`;
            document.getElementById('authorLink').href = channelUrl;
            document.getElementById('authorName').href = channelUrl;
            document.getElementById('authorName').innerText = ud.name;
            document.getElementById('authorIcon').src = ud.icon || "";
            document.getElementById('subCountDisplay').innerText = (ud.subscribers || 0).toLocaleString();
        }

        // é«˜è©•ä¾¡ãƒœã‚¿ãƒ³
        document.getElementById('likeBtn').onclick = async () => {
            if (!currentUser) return alert("ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™");
            const btn = document.getElementById('likeBtn');
            const likeRef = doc(db, "videos", vid, "likedUsers", currentUser.uid);
            if (btn.classList.contains('active')) {
                await deleteDoc(likeRef);
                await updateDoc(vRef, { likes: increment(-1) });
                btn.classList.remove('active');
                document.getElementById('likeCount').innerText = parseInt(document.getElementById('likeCount').innerText) - 1;
            } else {
                await setDoc(likeRef, { uid: currentUser.uid });
                await updateDoc(vRef, { likes: increment(1) });
                btn.classList.add('active');
                document.getElementById('likeCount').innerText = parseInt(document.getElementById('likeCount').innerText) + 1;
            }
        };

        // ç™»éŒ²ãƒœã‚¿ãƒ³
        document.getElementById('subBtn').onclick = async () => {
            if (!currentUser) return alert("ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™");
            const sBtn = document.getElementById('subBtn');
            const authorId = v.userId;
            const subRef = doc(db, "users", authorId, "subscriberList", currentUser.uid);
            if (sBtn.classList.contains('active')) {
                await deleteDoc(subRef);
                await updateDoc(uRef, { subscribers: increment(-1) });
                sBtn.innerText = "ãƒãƒ£ãƒ³ãƒãƒ«ç™»éŒ²";
                sBtn.classList.remove('active');
            } else {
                await setDoc(subRef, { uid: currentUser.uid });
                await updateDoc(uRef, { subscribers: increment(1) });
                sBtn.innerText = "ç™»éŒ²æ¸ˆã¿";
                sBtn.classList.add('active');
            }
            const updatedSnap = await getDoc(uRef);
            document.getElementById('subCountDisplay').innerText = (updatedSnap.data().subscribers || 0).toLocaleString();
        };

        const cCol = collection(db, "videos", vid, "comments");
        onSnapshot(cCol, snap => {
            document.getElementById('commentHeader').innerText = `ã‚³ãƒ¡ãƒ³ãƒˆ ${snap.size}ä»¶`;
            document.getElementById('commentList').innerHTML = "";
            snap.forEach(doc => {
                const c = doc.data();
                document.getElementById('commentList').innerHTML += `<div class="comment-item"><div><strong>${c.userName || 'åç„¡ã—ã•ã‚“'}</strong><br>${c.text}</div></div>`;
            });
        });

        document.getElementById('commentInput').onkeypress = async (e) => {
            if (e.key === 'Enter' && currentUser && e.target.value.trim() !== "") {
                const mySnap = await getDoc(doc(db, "users", currentUser.uid));
                await addDoc(cCol, { text: e.target.value, userName: mySnap.data()?.name || "åŒ¿å", userId: currentUser.uid, createdAt: serverTimestamp() });
                e.target.value = "";
            }
        };

        const vCols = await getDocs(query(collection(db, "videos"), limit(10)));
        vCols.forEach(doc => {
            if (doc.id !== vid) {
                const rv = doc.data();
                const rid = doc.id;
                const rThumbId = `rthumb-${rid}`;
                document.getElementById('relatedList').innerHTML += `<a href="watch.html?id=${rid}" class="side-card"><img id="${rThumbId}" class="side-thumb" src=""><div style="font-size:13px; font-weight:bold;">${rv.title}</div></a>`;
                setTimeout(() => {
                    const img = document.getElementById(rThumbId);
                    if (rv.thumbnail) img.src = rv.thumbnail;
                    else generateThumb(rv.url, img);
                }, 100);
            }
        });
        updateDoc(vRef, { views: increment(1) });
    }

    function generateThumb(url, imgElement) {
        const v = document.createElement('video');
        v.src = url; v.preload = "metadata"; v.muted = true; v.crossOrigin = "anonymous";
        v.onloadedmetadata = () => { v.currentTime = 1.0; };
        v.onseeked = () => {
            const c = document.createElement('canvas'); c.width = 160; c.height = 90;
            c.getContext('2d').drawImage(v, 0, 0, 160, 90);
            imgElement.src = c.toDataURL('image/jpeg');
            v.remove();
        };
    }
</script>
</body>
</html>

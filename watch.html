<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MyTube - å†ç”Ÿ</title>
    <style>
        :root { --yt-bg: #ffffff; --yt-text: #0f0f0f; --yt-gray: #606060; --yt-card: #f2f2f2; }
        body { font-family: "Roboto", Arial, sans-serif; margin: 0; background: var(--yt-bg); color: var(--yt-text); }
        header { display: flex; align-items: center; padding: 10px 15px; background: var(--yt-bg); border-bottom: 1px solid #ddd; position: sticky; top: 0; z-index: 100; }
        .logo { color: #ff0000; font-size: 20px; font-weight: bold; cursor: pointer; text-decoration: none; }
        .main-container { max-width: 1200px; margin: 0 auto; display: grid; grid-template-columns: 1fr 350px; gap: 20px; padding: 15px; }
        @media (max-width: 1000px) { .main-container { grid-template-columns: 1fr; padding: 0; } .video-section video { border-radius: 0; } .video-title, .stats-bar, .channel-info, .comment-section { padding: 0 15px; } }
        .video-section video { width: 100%; aspect-ratio: 16/9; background: #000; border-radius: 12px; }
        #adminPanel { display: none; background: #f9f9f9; color: #b8860b; padding: 15px; border-radius: 12px; margin: 10px; border: 1px solid gold; }
        
        /* â˜…ãƒœã‚¿ãƒ³ãŒç¸¦ã«æŠ˜ã‚Œãªã„ã‚ˆã†ã«ä¿®æ­£ */
        .yt-btn { 
            background: var(--yt-card); 
            border: none; 
            padding: 8px 16px; 
            border-radius: 20px; 
            font-weight: bold; 
            cursor: pointer; 
            font-size: 13px;
            white-space: nowrap; /* æ–‡å­—ãŒå‹æ‰‹ã«æ”¹è¡Œã•ã‚Œãªã„ã‚ˆã†ã«å›ºå®š */
            min-width: fit-content; /* ä¸­èº«ã®å¹…ã«åˆã‚ã›ã‚‹ */
        }
        
        .sub-btn { background: #0f0f0f; color: #fff; border-radius: 20px; padding: 8px 16px; border: none; font-weight: bold; margin-left: auto; cursor: pointer; }
        .sub-btn.subscribed { background: #eee; color: #606060; }
        
        /* ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿éƒ¨åˆ†ï¼šæ¨ªä¸¦ã³ */
        .comment-input-area { display: flex; align-items: center; gap: 12px; margin-bottom: 30px; }
        .comment-input-area input { flex: 1; border: none; border-bottom: 1px solid #ddd; outline: none; padding: 8px 0; font-size: 14px; background: transparent; }
        .comment-input-area button { flex-shrink: 0; } /* ãƒœã‚¿ãƒ³ãŒæ½°ã‚Œãªã„ã‚ˆã†ã«è¨­å®š */

        .comment-item { display: flex; gap: 10px; margin-bottom: 20px; }
        .c-icon { width: 32px; height: 32px; border-radius: 50%; }
        .c-actions { font-size: 12px; color: var(--yt-gray); margin-top: 5px; cursor: pointer; display: flex; gap: 10px; }
        .reply-list { margin-left: 40px; margin-top: 10px; border-left: 2px solid #eee; padding-left: 10px; }
        .reply-box, .edit-box { display: none; margin-top: 10px; }
        .reply-box input, .edit-box input { width: 100%; border: none; border-bottom: 1px solid #ddd; outline: none; margin-bottom: 5px; background: transparent; }
    </style>
</head>
<body>
<header><a href="index.html" class="logo">MyTube</a></header>
<div class="main-container">
    <div class="video-section">
        <div id="adminPanel">ğŸ‘‘ ç®¡ç†: å†ç”Ÿ <input type="number" id="admViews"> è©•ä¾¡ <input type="number" id="admLikes"> ç™»éŒ² <input type="number" id="admSubs"> <button onclick="adminSave()">ä¿å­˜</button></div>
        <video id="player" controls playsinline autoplay></video>
        <h2 class="video-title" id="vTitle">...</h2>
        <div class="stats-bar"><div class="v-meta"><span id="vViews">0</span>å›è¦–è´</div><button class="yt-btn" id="likeBtn">ğŸ‘ <span id="vLikes">0</span></button></div>
        <div class="channel-info">
            <img src="" class="channel-icon" id="cIcon" onclick="toChannel()" style="width:40px; height:40px; border-radius:50%;">
            <div><div id="cName" style="font-weight:bold;" onclick="toChannel()">...</div><div id="cSubs" style="font-size:12px; color:var(--yt-gray);">...</div></div>
            <button class="sub-btn" id="subBtn">ãƒãƒ£ãƒ³ãƒãƒ«ç™»éŒ²</button>
        </div>
        <div class="comment-section">
            <div class="comment-input-area">
                <input type="text" id="commentInput" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›...">
                <button class="yt-btn" id="commentBtn">æŠ•ç¨¿</button>
            </div>
            <div id="commentList"></div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, query, where, addDoc, deleteDoc, serverTimestamp, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAZivYKOGc1tSUAIDq_c10C1wJ-Pdh0U2o",
        authDomain: "mytube-f4544.firebaseapp.com",
        projectId: "mytube-f4544",
        storageBucket: "mytube-f4544.firebasestorage.app",
        messagingSenderId: "655444283107",
        appId: "1:655444283107:web:04f9173faf2d951790ffd6"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const vId = new URLSearchParams(window.location.search).get('id');
    let user = null, authorId = "";

    onAuthStateChanged(auth, u => { user = u; loadVideo(); loadComments(); });

    async function loadVideo() {
        if(!vId) return;
        onSnapshot(doc(db, "videos", vId), async snap => {
            const d = snap.data(); authorId = d.userId;
            document.getElementById('player').src = d.url;
            document.getElementById('vTitle').innerText = d.title;
            document.getElementById('vViews').innerText = d.views || 0;
            document.getElementById('vLikes').innerText = d.likes || 0;
            onSnapshot(doc(db, "users", d.userId), u => {
                document.getElementById('cName').innerText = u.data().name;
                document.getElementById('cIcon').src = u.data().icon;
                document.getElementById('cSubs').innerText = `ç™»éŒ²è€… ${u.data().subCount || 0}äºº`;
            });
        });
    }

    async function sendComment(txt = "", pid = null) {
        const val = txt || document.getElementById(pid ? `ri-${pid}` : 'commentInput').value;
        if(!val || !user) return alert("ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™");
        const u = await getDoc(doc(db, "users", user.uid));
        await addDoc(collection(db, "comments"), { videoId:vId, userId:user.uid, text:val, userName:u.data().name, userIcon:u.data().icon, parentId:pid, createdAt:serverTimestamp() });
        if(!pid) document.getElementById('commentInput').value = "";
        else document.getElementById(`rb-${pid}`).style.display = 'none';
    }
    document.getElementById('commentBtn').onclick = () => sendComment();

    function loadComments() {
        onSnapshot(query(collection(db, "comments"), where("videoId", "==", vId)), snap => {
            const list = document.getElementById('commentList'); list.innerHTML = "";
            const all = []; snap.forEach(d => all.push({id:d.id, ...d.data()}));
            all.filter(c => !c.parentId).sort((a,b) => b.createdAt - a.createdAt).forEach(c => {
                const div = document.createElement('div'); div.className = "comment-item";
                div.innerHTML = `
                    <img src="${c.userIcon}" class="c-icon">
                    <div style="flex:1;"><div style="font-weight:bold; font-size:13px;">${c.userName}</div>
                    <div id="t-${c.id}">${c.text}</div>
                    <div class="edit-box" id="eb-${c.id}"><input type="text" id="ei-${c.id}" value="${c.text}"><button class="yt-btn" onclick="saveEdit('${c.id}')">ä¿å­˜</button></div>
                    <div class="c-actions"><span onclick="showReply('${c.id}')">è¿”ä¿¡</span>${user && user.uid===c.userId?`<span onclick="showEdit('${c.id}')">ç·¨é›†</span>`:''}</div>
                    <div class="reply-box" id="rb-${c.id}"><input type="text" id="ri-${c.id}" placeholder="è¿”ä¿¡ã‚’å…¥åŠ›..."><button class="yt-btn" onclick="sendReply('${c.id}')">è¿”ä¿¡</button></div>
                    <div class="reply-list">${all.filter(r=>r.parentId===c.id).map(r=>`<div style="display:flex; gap:10px; margin-top:10px;"><img src="${r.userIcon}" style="width:24px;height:24px;border-radius:50%;"><div><div style="font-weight:bold;font-size:12px;">${r.userName}</div><div>${r.text}</div></div></div>`).join('')}</div></div>
                `;
                list.appendChild(div);
            });
        });
    }

    window.showReply = id => { const el = document.getElementById(`rb-${id}`); el.style.display = el.style.display==='block'?'none':'block'; };
    window.sendReply = id => sendComment("", id);
    window.showEdit = id => { document.getElementById(`t-${id}`).style.display='none'; document.getElementById(`eb-${id}`).style.display='block'; };
    window.saveEdit = async id => { await updateDoc(doc(db, "comments", id), { text: document.getElementById(`ei-${id}`).value }); document.getElementById(`t-${id}`).style.display='block'; document.getElementById(`eb-${id}`).style.display='none'; };
    window.toChannel = () => location.href = `channel.html?uid=${authorId}`;
</script>
</body>
</html>

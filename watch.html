<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyTube - „É≠„Ç∞„Ç§„É≥„Åó„Å¶„Ç≥„É°„É≥„Éà</title>
    <style>
        body { font-family: sans-serif; margin: 0; background: #f9f9f9; padding: 20px; }
        .main-container { max-width: 900px; margin: 0 auto; }
        video { width: 100%; background: #000; border-radius: 12px; }
        .actions { display: flex; gap: 10px; margin: 15px 0; border-bottom: 1px solid #ddd; padding-bottom: 15px; }
        button { padding: 8px 16px; border-radius: 20px; border: none; cursor: pointer; font-weight: bold; }
        .btn-sub { background: #0f0f0f; color: white; }
        
        /* „É≠„Ç∞„Ç§„É≥„Ç®„É™„Ç¢ */
        .auth-section { margin-bottom: 20px; text-align: right; }
        .user-profile { display: flex; align-items: center; justify-content: flex-end; gap: 10px; }
        .user-icon { width: 32px; height: 32px; border-radius: 50%; }
        
        .comment-section { background: white; padding: 20px; border-radius: 12px; }
        .input-area { margin-bottom: 20px; padding: 15px; border: 1px solid #eee; border-radius: 8px; }
        #commentInput { width: 100%; padding: 10px; border: none; border-bottom: 1px solid #ddd; outline: none; margin-bottom: 10px; }
        
        .comment-item { border-bottom: 1px solid #eee; padding: 15px 0; display: flex; gap: 12px; }
        .comment-right { flex-grow: 1; }
        .user-name { font-weight: bold; font-size: 13px; margin-bottom: 4px; }
        .comment-text { font-size: 14px; }
    </style>
</head>
<body>
<div class="main-container">
    <div class="auth-section" id="authSection">
        <button onclick="login()">Google„Åß„É≠„Ç∞„Ç§„É≥</button>
    </div>

    <video id="player" controls autoplay></video>
    <h2 id="videoTitle">Ë™≠„ÅøËæº„Åø‰∏≠...</h2>
    
    <div class="actions">
        <button class="btn-sub" onclick="alert('ÁôªÈå≤„Åó„Åæ„Åó„Åü')">„ÉÅ„É£„É≥„Éç„É´ÁôªÈå≤</button>
        <button class="btn-like" onclick="alert('È´òË©ï‰æ°')">üëç</button>
    </div>

    <div class="comment-section">
        <h3>„Ç≥„É°„É≥„Éà</h3>
        <div class="input-area" id="inputArea" style="display:none;">
            <input type="text" id="commentInput" placeholder="„Ç≥„É°„É≥„Éà„ÇíÂÖ•Âäõ...">
            <button onclick="sendComment()">ÊäïÁ®ø</button>
        </div>
        <p id="loginMsg">„Ç≥„É°„É≥„Éà„Åô„Çã„Å´„ÅØ„É≠„Ç∞„Ç§„É≥„ÅåÂøÖË¶Å„Åß„Åô</p>
        <div id="commentList"></div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, getDoc, collection, addDoc, query, where, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAZivYKOGc1tSUAIDq_c10C1wJ-Pdh0U2o",
        authDomain: "mytube-f4544.firebaseapp.com",
        projectId: "mytube-f4544",
        storageBucket: "mytube-f4544.firebasestorage.app",
        messagingSenderId: "655444283107",
        appId: "1:655444283107:web:04f9173faf2d951790ffd6"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    let currentUser = null;
    const params = new URLSearchParams(window.location.search);
    const videoId = params.get('id');

    // „É≠„Ç∞„Ç§„É≥Âá¶ÁêÜ
    window.login = () => signInWithPopup(auth, provider);
    window.logout = () => signOut(auth);

    // „É≠„Ç∞„Ç§„É≥Áä∂ÊÖã„ÇíÁõ£Ë¶ñ
    onAuthStateChanged(auth, (user) => {
        const authSection = document.getElementById('authSection');
        const inputArea = document.getElementById('inputArea');
        const loginMsg = document.getElementById('loginMsg');

        if (user) {
            currentUser = user;
            authSection.innerHTML = `
                <div class="user-profile">
                    <img src="${user.photoURL}" class="user-icon">
                    <span>${user.displayName}</span>
                    <button onclick="logout()">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>
                </div>`;
            inputArea.style.display = 'block';
            loginMsg.style.display = 'none';
        } else {
            currentUser = null;
            authSection.innerHTML = `<button onclick="login()">Google„Åß„É≠„Ç∞„Ç§„É≥</button>`;
            inputArea.style.display = 'none';
            loginMsg.style.display = 'block';
        }
    });

    // ÂãïÁîªË™≠„ÅøËæº„Åø
    async function loadVideoData() {
        if (!videoId) return;
        const docSnap = await getDoc(doc(db, "videos", videoId));
        if (docSnap.exists()) {
            document.getElementById('player').src = docSnap.data().url;
            document.getElementById('videoTitle').innerText = docSnap.data().title;
        }
    }

    // „Ç≥„É°„É≥„ÉàÊäïÁ®ø
    window.sendComment = async function() {
        const input = document.getElementById('commentInput');
        if (!input.value || !currentUser) return;
        await addDoc(collection(db, "comments"), {
            videoId: videoId,
            userName: currentUser.displayName,
            userIcon: currentUser.photoURL,
            text: input.value,
            createdAt: serverTimestamp()
        });
        input.value = "";
    };

    // „Ç≥„É°„É≥„ÉàË°®Á§∫
    if (videoId) {
        onSnapshot(query(collection(db, "comments"), where("videoId", "==", videoId)), (snapshot) => {
            const list = document.getElementById('commentList');
            list.innerHTML = "";
            snapshot.forEach(doc => {
                const data = doc.data();
                const div = document.createElement('div');
                div.className = 'comment-item';
                div.innerHTML = `
                    <img src="${data.userIcon || ''}" class="user-icon">
                    <div class="comment-right">
                        <div class="user-name">${data.userName}</div>
                        <div class="comment-text">${data.text}</div>
                    </div>`;
                list.appendChild(div);
            });
        });
    }
    loadVideoData();
</script>
</body>
</html>
